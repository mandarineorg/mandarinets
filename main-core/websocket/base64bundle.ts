// Copyright 2020-2020 The Mandarine.TS Framework authors. All rights reserved. MIT license.

// from: WebSocket.ts
export const WebSocketBase64Const = `data:application/javascript;base64,ZnVuY3Rpb24gZGVmZXJyZWQoKSB7CiAgICBsZXQgbWV0aG9kczsKICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KT0+ewogICAgICAgIG1ldGhvZHMgPSB7CiAgICAgICAgICAgIHJlc29sdmUsCiAgICAgICAgICAgIHJlamVjdAogICAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKHByb21pc2UsIG1ldGhvZHMpOwp9CmNvbnN0IGRlZmVycmVkMSA9IGRlZmVycmVkOwpjbGFzcyBNdXhBc3luY0l0ZXJhdG9yIHsKICAgIGl0ZXJhdG9yQ291bnQgPSAwOwogICAgeWllbGRzID0gW107CiAgICB0aHJvd3MgPSBbXTsKICAgIHNpZ25hbCA9IGRlZmVycmVkKCk7CiAgICBhZGQoaXRlcmF0b3IpIHsKICAgICAgICArK3RoaXMuaXRlcmF0b3JDb3VudDsKICAgICAgICB0aGlzLmNhbGxJdGVyYXRvck5leHQoaXRlcmF0b3IpOwogICAgfQogICAgYXN5bmMgY2FsbEl0ZXJhdG9yTmV4dChpdGVyYXRvcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHsgdmFsdWUgLCBkb25lICB9ID0gYXdhaXQgaXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICAgLS10aGlzLml0ZXJhdG9yQ291bnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnlpZWxkcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBpdGVyYXRvciwKICAgICAgICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dzLnB1c2goZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2lnbmFsLnJlc29sdmUoKTsKICAgIH0KICAgIGFzeW5jICppdGVyYXRlKCkgewogICAgICAgIHdoaWxlKHRoaXMuaXRlcmF0b3JDb3VudCA+IDApewogICAgICAgICAgICBhd2FpdCB0aGlzLnNpZ25hbDsKICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMueWllbGRzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgIGNvbnN0IHsgaXRlcmF0b3IgLCB2YWx1ZSAgfSA9IHRoaXMueWllbGRzW2ldOwogICAgICAgICAgICAgICAgeWllbGQgdmFsdWU7CiAgICAgICAgICAgICAgICB0aGlzLmNhbGxJdGVyYXRvck5leHQoaXRlcmF0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnRocm93cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZSBvZiB0aGlzLnRocm93cyl7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudGhyb3dzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy55aWVsZHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5zaWduYWwgPSBkZWZlcnJlZDEoKTsKICAgICAgICB9CiAgICB9CiAgICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgICAgIHJldHVybiB0aGlzLml0ZXJhdGUoKTsKICAgIH0KfQpmdW5jdGlvbiBlbXB0eVJlYWRlcigpIHsKICAgIHJldHVybiB7CiAgICAgICAgcmVhZCAoXykgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgZW1wdHlSZWFkZXIxID0gZW1wdHlSZWFkZXI7CmZ1bmN0aW9uIGJvZHlSZWFkZXIoY29udGVudExlbmd0aCwgcikgewogICAgbGV0IHRvdGFsUmVhZCA9IDA7CiAgICBsZXQgZmluaXNoZWQgPSBmYWxzZTsKICAgIGFzeW5jIGZ1bmN0aW9uIHJlYWQoYnVmKSB7CiAgICAgICAgaWYgKGZpbmlzaGVkKSByZXR1cm4gbnVsbDsKICAgICAgICBsZXQgcmVzdWx0OwogICAgICAgIGNvbnN0IHJlbWFpbmluZyA9IGNvbnRlbnRMZW5ndGggLSB0b3RhbFJlYWQ7CiAgICAgICAgaWYgKHJlbWFpbmluZyA+PSBidWYuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICByZXN1bHQgPSBhd2FpdCByLnJlYWQoYnVmKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCByZWFkQnVmID0gYnVmLnN1YmFycmF5KDAsIHJlbWFpbmluZyk7CiAgICAgICAgICAgIHJlc3VsdCA9IGF3YWl0IHIucmVhZChyZWFkQnVmKTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgICB0b3RhbFJlYWQgKz0gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBmaW5pc2hlZCA9IHRvdGFsUmVhZCA9PT0gY29udGVudExlbmd0aDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgcmV0dXJuIHsKICAgICAgICByZWFkCiAgICB9Owp9CmNvbnN0IGJvZHlSZWFkZXIxID0gYm9keVJlYWRlcjsKZnVuY3Rpb24gaW5kZXhPZihzb3VyY2UsIHBhdCwgc3RhcnQgPSAwKSB7CiAgICBpZiAoc3RhcnQgPj0gc291cmNlLmxlbmd0aCkgewogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIGlmIChzdGFydCA8IDApIHsKICAgICAgICBzdGFydCA9IDA7CiAgICB9CiAgICBjb25zdCBzID0gcGF0WzBdOwogICAgZm9yKGxldCBpID0gc3RhcnQ7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspewogICAgICAgIGlmIChzb3VyY2VbaV0gIT09IHMpIGNvbnRpbnVlOwogICAgICAgIGNvbnN0IHBpbiA9IGk7CiAgICAgICAgbGV0IG1hdGNoZWQgPSAxOwogICAgICAgIGxldCBqID0gaTsKICAgICAgICB3aGlsZShtYXRjaGVkIDwgcGF0Lmxlbmd0aCl7CiAgICAgICAgICAgIGorKzsKICAgICAgICAgICAgaWYgKHNvdXJjZVtqXSAhPT0gcGF0W2ogLSBwaW5dKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaGVkKys7CiAgICAgICAgfQogICAgICAgIGlmIChtYXRjaGVkID09PSBwYXQubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBwaW47CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwp9CmZ1bmN0aW9uIGNvbmNhdCguLi5idWYpIHsKICAgIGxldCBsZW5ndGggPSAwOwogICAgZm9yIChjb25zdCBiIG9mIGJ1Zil7CiAgICAgICAgbGVuZ3RoICs9IGIubGVuZ3RoOwogICAgfQogICAgY29uc3Qgb3V0cHV0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKTsKICAgIGxldCBpbmRleCA9IDA7CiAgICBmb3IgKGNvbnN0IGIxIG9mIGJ1Zil7CiAgICAgICAgb3V0cHV0LnNldChiMSwgaW5kZXgpOwogICAgICAgIGluZGV4ICs9IGIxLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiBvdXRwdXQ7Cn0KY29uc3QgY29uY2F0MSA9IGNvbmNhdDsKY29uc3QgY29uY2F0MiA9IGNvbmNhdDsKZnVuY3Rpb24gY29weShzcmMsIGRzdCwgb2ZmID0gMCkgewogICAgb2ZmID0gTWF0aC5tYXgoMCwgTWF0aC5taW4ob2ZmLCBkc3QuYnl0ZUxlbmd0aCkpOwogICAgY29uc3QgZHN0Qnl0ZXNBdmFpbGFibGUgPSBkc3QuYnl0ZUxlbmd0aCAtIG9mZjsKICAgIGlmIChzcmMuYnl0ZUxlbmd0aCA+IGRzdEJ5dGVzQXZhaWxhYmxlKSB7CiAgICAgICAgc3JjID0gc3JjLnN1YmFycmF5KDAsIGRzdEJ5dGVzQXZhaWxhYmxlKTsKICAgIH0KICAgIGRzdC5zZXQoc3JjLCBvZmYpOwogICAgcmV0dXJuIHNyYy5ieXRlTGVuZ3RoOwp9CmNvbnN0IGNvcHkxID0gY29weTsKY29uc3QgaW52YWxpZEhlYWRlckNoYXJSZWdleCA9IC9bXlx0XHgyMC1ceDdlXHg4MC1ceGZmXS9nOwpjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7CmNvbnN0IGVuY29kZXIxID0gZW5jb2RlcjsKZnVuY3Rpb24gZW5jb2RlKGlucHV0KSB7CiAgICByZXR1cm4gZW5jb2Rlci5lbmNvZGUoaW5wdXQpOwp9CmNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKZnVuY3Rpb24gZGVjb2RlKGlucHV0KSB7CiAgICByZXR1cm4gZGVjb2Rlci5kZWNvZGUoaW5wdXQpOwp9CmZ1bmN0aW9uIHN0cihidWYpIHsKICAgIGlmIChidWYgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAiIjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRlY29kZShidWYpOwogICAgfQp9CmZ1bmN0aW9uIGNoYXJDb2RlKHMpIHsKICAgIHJldHVybiBzLmNoYXJDb2RlQXQoMCk7Cn0KY2xhc3MgVGV4dFByb3RvUmVhZGVyIHsKICAgIGNvbnN0cnVjdG9yKHIxKXsKICAgICAgICB0aGlzLnIgPSByMTsKICAgIH0KICAgIGFzeW5jIHJlYWRMaW5lKCkgewogICAgICAgIGNvbnN0IHMgPSBhd2FpdCB0aGlzLnJlYWRMaW5lU2xpY2UoKTsKICAgICAgICBpZiAocyA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIHN0cihzKTsKICAgIH0KICAgIGFzeW5jIHJlYWRNSU1FSGVhZGVyKCkgewogICAgICAgIGNvbnN0IG0gPSBuZXcgSGVhZGVycygpOwogICAgICAgIGxldCBsaW5lOwogICAgICAgIGxldCBidWYgPSBhd2FpdCB0aGlzLnIucGVlaygxKTsKICAgICAgICBpZiAoYnVmID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0gZWxzZSBpZiAoYnVmWzBdID09IGNoYXJDb2RlKCIgIikgfHwgYnVmWzBdID09IGNoYXJDb2RlKCJcdCIpKSB7CiAgICAgICAgICAgIGxpbmUgPSBhd2FpdCB0aGlzLnJlYWRMaW5lU2xpY2UoKTsKICAgICAgICB9CiAgICAgICAgYnVmID0gYXdhaXQgdGhpcy5yLnBlZWsoMSk7CiAgICAgICAgaWYgKGJ1ZiA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRGVuby5lcnJvcnMuVW5leHBlY3RlZEVvZigpOwogICAgICAgIH0gZWxzZSBpZiAoYnVmWzBdID09IGNoYXJDb2RlKCIgIikgfHwgYnVmWzBdID09IGNoYXJDb2RlKCJcdCIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YShgbWFsZm9ybWVkIE1JTUUgaGVhZGVyIGluaXRpYWwgbGluZTogJHtzdHIobGluZSl9YCk7CiAgICAgICAgfQogICAgICAgIHdoaWxlKHRydWUpewogICAgICAgICAgICBjb25zdCBrdiA9IGF3YWl0IHRoaXMucmVhZExpbmVTbGljZSgpOwogICAgICAgICAgICBpZiAoa3YgPT09IG51bGwpIHRocm93IG5ldyBEZW5vLmVycm9ycy5VbmV4cGVjdGVkRW9mKCk7CiAgICAgICAgICAgIGlmIChrdi5ieXRlTGVuZ3RoID09PSAwKSByZXR1cm4gbTsKICAgICAgICAgICAgbGV0IGkgPSBrdi5pbmRleE9mKGNoYXJDb2RlKCI6IikpOwogICAgICAgICAgICBpZiAoaSA8IDApIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YShgbWFsZm9ybWVkIE1JTUUgaGVhZGVyIGxpbmU6ICR7c3RyKGt2KX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBrZXkgPSBzdHIoa3Yuc3ViYXJyYXkoMCwgaSkpOwogICAgICAgICAgICBpZiAoa2V5ID09ICIiKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpKys7CiAgICAgICAgICAgIHdoaWxlKGkgPCBrdi5ieXRlTGVuZ3RoICYmIChrdltpXSA9PSBjaGFyQ29kZSgiICIpIHx8IGt2W2ldID09IGNoYXJDb2RlKCJcdCIpKSl7CiAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzdHIoa3Yuc3ViYXJyYXkoaSkpLnJlcGxhY2UoaW52YWxpZEhlYWRlckNoYXJSZWdleCwgZW5jb2RlVVJJKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG0uYXBwZW5kKGtleSwgdmFsdWUpOwogICAgICAgICAgICB9IGNhdGNoICB7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyByZWFkTGluZVNsaWNlKCkgewogICAgICAgIGxldCBsaW5lOwogICAgICAgIHdoaWxlKHRydWUpewogICAgICAgICAgICBjb25zdCByMSA9IGF3YWl0IHRoaXMuci5yZWFkTGluZSgpOwogICAgICAgICAgICBpZiAocjEgPT09IG51bGwpIHJldHVybiBudWxsOwogICAgICAgICAgICBjb25zdCB7IGxpbmU6IGwgLCBtb3JlICB9ID0gcjE7CiAgICAgICAgICAgIGlmICghbGluZSAmJiAhbW9yZSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2tpcFNwYWNlKGwpID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGluZSA9IGxpbmUgPyBjb25jYXQyKGxpbmUsIGwpIDogbDsKICAgICAgICAgICAgaWYgKCFtb3JlKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbGluZTsKICAgIH0KICAgIHNraXBTcGFjZShsKSB7CiAgICAgICAgbGV0IG4gPSAwOwogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKGxbaV0gPT09IGNoYXJDb2RlKCIgIikgfHwgbFtpXSA9PT0gY2hhckNvZGUoIlx0IikpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG47CiAgICB9Cn0KY2xhc3MgRGVub1N0ZEludGVybmFsRXJyb3IgZXh0ZW5kcyBFcnJvciB7CiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlMSl7CiAgICAgICAgc3VwZXIobWVzc2FnZTEpOwogICAgICAgIHRoaXMubmFtZSA9ICJEZW5vU3RkSW50ZXJuYWxFcnJvciI7CiAgICB9Cn0KZnVuY3Rpb24gYXNzZXJ0KGV4cHIsIG1zZyA9ICIiKSB7CiAgICBpZiAoIWV4cHIpIHsKICAgICAgICB0aHJvdyBuZXcgRGVub1N0ZEludGVybmFsRXJyb3IobXNnKTsKICAgIH0KfQpmdW5jdGlvbiBjaHVua2VkQm9keVJlYWRlcihoLCByMSkgewogICAgY29uc3QgdHAgPSBuZXcgVGV4dFByb3RvUmVhZGVyKHIxKTsKICAgIGxldCBmaW5pc2hlZCA9IGZhbHNlOwogICAgY29uc3QgY2h1bmtzID0gW107CiAgICBhc3luYyBmdW5jdGlvbiByZWFkKGJ1ZikgewogICAgICAgIGlmIChmaW5pc2hlZCkgcmV0dXJuIG51bGw7CiAgICAgICAgY29uc3QgW2NodW5rXSA9IGNodW5rczsKICAgICAgICBpZiAoY2h1bmspIHsKICAgICAgICAgICAgY29uc3QgY2h1bmtSZW1haW5pbmcgPSBjaHVuay5kYXRhLmJ5dGVMZW5ndGggLSBjaHVuay5vZmZzZXQ7CiAgICAgICAgICAgIGNvbnN0IHJlYWRMZW5ndGggPSBNYXRoLm1pbihjaHVua1JlbWFpbmluZywgYnVmLmJ5dGVMZW5ndGgpOwogICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgcmVhZExlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgIGJ1ZltpXSA9IGNodW5rLmRhdGFbY2h1bmsub2Zmc2V0ICsgaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2h1bmsub2Zmc2V0ICs9IHJlYWRMZW5ndGg7CiAgICAgICAgICAgIGlmIChjaHVuay5vZmZzZXQgPT09IGNodW5rLmRhdGEuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICAgICAgY2h1bmtzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICBpZiAoYXdhaXQgdHAucmVhZExpbmUoKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5VbmV4cGVjdGVkRW9mKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlYWRMZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxpbmUgPSBhd2FpdCB0cC5yZWFkTGluZSgpOwogICAgICAgIGlmIChsaW5lID09PSBudWxsKSB0aHJvdyBuZXcgRGVuby5lcnJvcnMuVW5leHBlY3RlZEVvZigpOwogICAgICAgIGNvbnN0IFtjaHVua1NpemVTdHJpbmddID0gbGluZS5zcGxpdCgiOyIpOwogICAgICAgIGNvbnN0IGNodW5rU2l6ZSA9IHBhcnNlSW50KGNodW5rU2l6ZVN0cmluZywgMTYpOwogICAgICAgIGlmIChOdW1iZXIuaXNOYU4oY2h1bmtTaXplKSB8fCBjaHVua1NpemUgPCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YSgiSW52YWxpZCBjaHVuayBzaXplIik7CiAgICAgICAgfQogICAgICAgIGlmIChjaHVua1NpemUgPiAwKSB7CiAgICAgICAgICAgIGlmIChjaHVua1NpemUgPiBidWYuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICAgICAgbGV0IGVvZiA9IGF3YWl0IHIxLnJlYWRGdWxsKGJ1Zik7CiAgICAgICAgICAgICAgICBpZiAoZW9mID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERlbm8uZXJyb3JzLlVuZXhwZWN0ZWRFb2YoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RDaHVuayA9IG5ldyBVaW50OEFycmF5KGNodW5rU2l6ZSAtIGJ1Zi5ieXRlTGVuZ3RoKTsKICAgICAgICAgICAgICAgIGVvZiA9IGF3YWl0IHIxLnJlYWRGdWxsKHJlc3RDaHVuayk7CiAgICAgICAgICAgICAgICBpZiAoZW9mID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IERlbm8uZXJyb3JzLlVuZXhwZWN0ZWRFb2YoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2h1bmtzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlc3RDaHVuawogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGJ1Zi5ieXRlTGVuZ3RoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgYnVmVG9GaWxsID0gYnVmLnN1YmFycmF5KDAsIGNodW5rU2l6ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBlb2YgPSBhd2FpdCByMS5yZWFkRnVsbChidWZUb0ZpbGwpOwogICAgICAgICAgICAgICAgaWYgKGVvZiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5VbmV4cGVjdGVkRW9mKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYXdhaXQgdHAucmVhZExpbmUoKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5VbmV4cGVjdGVkRW9mKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY2h1bmtTaXplOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXNzZXJ0KGNodW5rU2l6ZSA9PT0gMCk7CiAgICAgICAgICAgIGlmIChhd2FpdCByMS5yZWFkTGluZSgpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRGVuby5lcnJvcnMuVW5leHBlY3RlZEVvZigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF3YWl0IHJlYWRUcmFpbGVycyhoLCByMSk7CiAgICAgICAgICAgIGZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICByZWFkCiAgICB9Owp9CmNvbnN0IGNodW5rZWRCb2R5UmVhZGVyMSA9IGNodW5rZWRCb2R5UmVhZGVyOwpmdW5jdGlvbiBpc1Byb2hpYmlkZWRGb3JUcmFpbGVyKGtleSkgewogICAgY29uc3QgcyA9IG5ldyBTZXQoWwogICAgICAgICJ0cmFuc2Zlci1lbmNvZGluZyIsCiAgICAgICAgImNvbnRlbnQtbGVuZ3RoIiwKICAgICAgICAidHJhaWxlciIKICAgIF0pOwogICAgcmV0dXJuIHMuaGFzKGtleS50b0xvd2VyQ2FzZSgpKTsKfQphc3luYyBmdW5jdGlvbiByZWFkVHJhaWxlcnMoaGVhZGVycywgcjEpIHsKICAgIGNvbnN0IHRyYWlsZXJzID0gcGFyc2VUcmFpbGVyKGhlYWRlcnMuZ2V0KCJ0cmFpbGVyIikpOwogICAgaWYgKHRyYWlsZXJzID09IG51bGwpIHJldHVybjsKICAgIGNvbnN0IHRyYWlsZXJOYW1lcyA9IFsKICAgICAgICAuLi50cmFpbGVycy5rZXlzKCkKICAgIF07CiAgICBjb25zdCB0cCA9IG5ldyBUZXh0UHJvdG9SZWFkZXIocjEpOwogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdHAucmVhZE1JTUVIZWFkZXIoKTsKICAgIGlmIChyZXN1bHQgPT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YSgiTWlzc2luZyB0cmFpbGVyIGhlYWRlci4iKTsKICAgIH0KICAgIGNvbnN0IHVuZGVjbGFyZWQgPSBbCiAgICAgICAgLi4ucmVzdWx0LmtleXMoKQogICAgXS5maWx0ZXIoKGspPT4hdHJhaWxlck5hbWVzLmluY2x1ZGVzKGspCiAgICApOwogICAgaWYgKHVuZGVjbGFyZWQubGVuZ3RoID4gMCkgewogICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YShgVW5kZWNsYXJlZCB0cmFpbGVyczogJHtEZW5vLmluc3BlY3QodW5kZWNsYXJlZCl9LmApOwogICAgfQogICAgZm9yIChjb25zdCBbaywgdl0gb2YgcmVzdWx0KXsKICAgICAgICBoZWFkZXJzLmFwcGVuZChrLCB2KTsKICAgIH0KICAgIGNvbnN0IG1pc3NpbmdUcmFpbGVycyA9IHRyYWlsZXJOYW1lcy5maWx0ZXIoKGsxKT0+IXJlc3VsdC5oYXMoazEpCiAgICApOwogICAgaWYgKG1pc3NpbmdUcmFpbGVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdGhyb3cgbmV3IERlbm8uZXJyb3JzLkludmFsaWREYXRhKGBNaXNzaW5nIHRyYWlsZXJzOiAke0Rlbm8uaW5zcGVjdChtaXNzaW5nVHJhaWxlcnMpfS5gKTsKICAgIH0KICAgIGhlYWRlcnMuZGVsZXRlKCJ0cmFpbGVyIik7Cn0KZnVuY3Rpb24gcGFyc2VUcmFpbGVyKGZpZWxkKSB7CiAgICBpZiAoZmllbGQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CiAgICBjb25zdCB0cmFpbGVyTmFtZXMgPSBmaWVsZC5zcGxpdCgiLCIpLm1hcCgodik9PnYudHJpbSgpLnRvTG93ZXJDYXNlKCkKICAgICk7CiAgICBpZiAodHJhaWxlck5hbWVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YSgiRW1wdHkgdHJhaWxlciBoZWFkZXIuIik7CiAgICB9CiAgICBjb25zdCBwcm9oaWJpdGVkID0gdHJhaWxlck5hbWVzLmZpbHRlcigoayk9PmlzUHJvaGliaWRlZEZvclRyYWlsZXIoaykKICAgICk7CiAgICBpZiAocHJvaGliaXRlZC5sZW5ndGggPiAwKSB7CiAgICAgICAgdGhyb3cgbmV3IERlbm8uZXJyb3JzLkludmFsaWREYXRhKGBQcm9oaWJpdGVkIHRyYWlsZXIgbmFtZXM6ICR7RGVuby5pbnNwZWN0KHByb2hpYml0ZWQpfS5gKTsKICAgIH0KICAgIHJldHVybiBuZXcgSGVhZGVycyh0cmFpbGVyTmFtZXMubWFwKChrZXkpPT5bCiAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgIiIKICAgICAgICBdCiAgICApKTsKfQphc3luYyBmdW5jdGlvbiB3cml0ZUNodW5rZWRCb2R5KHcsIHIxKSB7CiAgICBmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIERlbm8uaXRlcihyMSkpewogICAgICAgIGlmIChjaHVuay5ieXRlTGVuZ3RoIDw9IDApIGNvbnRpbnVlOwogICAgICAgIGNvbnN0IHN0YXJ0ID0gZW5jb2Rlci5lbmNvZGUoYCR7Y2h1bmsuYnl0ZUxlbmd0aC50b1N0cmluZygxNil9XHJcbmApOwogICAgICAgIGNvbnN0IGVuZCA9IGVuY29kZXIuZW5jb2RlKCJcclxuIik7CiAgICAgICAgYXdhaXQgdy53cml0ZShzdGFydCk7CiAgICAgICAgYXdhaXQgdy53cml0ZShjaHVuayk7CiAgICAgICAgYXdhaXQgdy53cml0ZShlbmQpOwogICAgICAgIGF3YWl0IHcuZmx1c2goKTsKICAgIH0KICAgIGNvbnN0IGVuZENodW5rID0gZW5jb2Rlci5lbmNvZGUoIjBcclxuXHJcbiIpOwogICAgYXdhaXQgdy53cml0ZShlbmRDaHVuayk7Cn0KY29uc3QgREVGQVVMVF9CVUZfU0laRSA9IDQwOTY7CmNvbnN0IE1JTl9CVUZfU0laRSA9IDE2Owpjb25zdCBDUiA9ICJcciIuY2hhckNvZGVBdCgwKTsKY29uc3QgTEYgPSAiXG4iLmNoYXJDb2RlQXQoMCk7CmNsYXNzIEJ1ZmZlckZ1bGxFcnJvciBleHRlbmRzIEVycm9yIHsKICAgIG5hbWUgPSAiQnVmZmVyRnVsbEVycm9yIjsKICAgIGNvbnN0cnVjdG9yKHBhcnRpYWwpewogICAgICAgIHN1cGVyKCJCdWZmZXIgZnVsbCIpOwogICAgICAgIHRoaXMucGFydGlhbCA9IHBhcnRpYWw7CiAgICB9Cn0KY2xhc3MgUGFydGlhbFJlYWRFcnJvciBleHRlbmRzIERlbm8uZXJyb3JzLlVuZXhwZWN0ZWRFb2YgewogICAgbmFtZSA9ICJQYXJ0aWFsUmVhZEVycm9yIjsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgICAgc3VwZXIoIkVuY291bnRlcmVkIFVuZXhwZWN0ZWRFb2YsIGRhdGEgb25seSBwYXJ0aWFsbHkgcmVhZCIpOwogICAgfQp9CmNsYXNzIEJ1ZlJlYWRlciB7CiAgICByID0gMDsKICAgIHcgPSAwOwogICAgZW9mID0gZmFsc2U7CiAgICBzdGF0aWMgY3JlYXRlKHIsIHNpemUgPSA0MDk2KSB7CiAgICAgICAgcmV0dXJuIHIgaW5zdGFuY2VvZiBCdWZSZWFkZXIgPyByIDogbmV3IEJ1ZlJlYWRlcihyLCBzaXplKTsKICAgIH0KICAgIGNvbnN0cnVjdG9yKHJkMSwgc2l6ZTEgPSA0MDk2KXsKICAgICAgICBpZiAoc2l6ZTEgPCAxNikgewogICAgICAgICAgICBzaXplMSA9IE1JTl9CVUZfU0laRTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVzZXQobmV3IFVpbnQ4QXJyYXkoc2l6ZTEpLCByZDEpOwogICAgfQogICAgc2l6ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWYuYnl0ZUxlbmd0aDsKICAgIH0KICAgIGJ1ZmZlcmVkKCkgewogICAgICAgIHJldHVybiB0aGlzLncgLSB0aGlzLnI7CiAgICB9CiAgICBhc3luYyBfZmlsbCgpIHsKICAgICAgICBpZiAodGhpcy5yID4gMCkgewogICAgICAgICAgICB0aGlzLmJ1Zi5jb3B5V2l0aGluKDAsIHRoaXMuciwgdGhpcy53KTsKICAgICAgICAgICAgdGhpcy53IC09IHRoaXMucjsKICAgICAgICAgICAgdGhpcy5yID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMudyA+PSB0aGlzLmJ1Zi5ieXRlTGVuZ3RoKSB7CiAgICAgICAgICAgIHRocm93IEVycm9yKCJidWZpbzogdHJpZWQgdG8gZmlsbCBmdWxsIGJ1ZmZlciIpOwogICAgICAgIH0KICAgICAgICBmb3IobGV0IGkgPSAxMDA7IGkgPiAwOyBpLS0pewogICAgICAgICAgICBjb25zdCByciA9IGF3YWl0IHRoaXMucmQucmVhZCh0aGlzLmJ1Zi5zdWJhcnJheSh0aGlzLncpKTsKICAgICAgICAgICAgaWYgKHJyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVvZiA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXNzZXJ0KHJyID49IDAsICJuZWdhdGl2ZSByZWFkIik7CiAgICAgICAgICAgIHRoaXMudyArPSBycjsKICAgICAgICAgICAgaWYgKHJyID4gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gcHJvZ3Jlc3MgYWZ0ZXIgJHsxMDB9IHJlYWQoKSBjYWxsc2ApOwogICAgfQogICAgcmVzZXQocikgewogICAgICAgIHRoaXMuX3Jlc2V0KHRoaXMuYnVmLCByKTsKICAgIH0KICAgIF9yZXNldChidWYsIHJkKSB7CiAgICAgICAgdGhpcy5idWYgPSBidWY7CiAgICAgICAgdGhpcy5yZCA9IHJkOwogICAgICAgIHRoaXMuZW9mID0gZmFsc2U7CiAgICB9CiAgICBhc3luYyByZWFkKHApIHsKICAgICAgICBsZXQgcnIgPSBwLmJ5dGVMZW5ndGg7CiAgICAgICAgaWYgKHAuYnl0ZUxlbmd0aCA9PT0gMCkgcmV0dXJuIHJyOwogICAgICAgIGlmICh0aGlzLnIgPT09IHRoaXMudykgewogICAgICAgICAgICBpZiAocC5ieXRlTGVuZ3RoID49IHRoaXMuYnVmLmJ5dGVMZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJyMSA9IGF3YWl0IHRoaXMucmQucmVhZChwKTsKICAgICAgICAgICAgICAgIGNvbnN0IG5yZWFkID0gcnIxID8/IDA7CiAgICAgICAgICAgICAgICBhc3NlcnQobnJlYWQgPj0gMCwgIm5lZ2F0aXZlIHJlYWQiKTsKICAgICAgICAgICAgICAgIHJldHVybiBycjE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5yID0gMDsKICAgICAgICAgICAgdGhpcy53ID0gMDsKICAgICAgICAgICAgcnIgPSBhd2FpdCB0aGlzLnJkLnJlYWQodGhpcy5idWYpOwogICAgICAgICAgICBpZiAocnIgPT09IDAgfHwgcnIgPT09IG51bGwpIHJldHVybiBycjsKICAgICAgICAgICAgYXNzZXJ0KHJyID49IDAsICJuZWdhdGl2ZSByZWFkIik7CiAgICAgICAgICAgIHRoaXMudyArPSBycjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29waWVkID0gY29weSh0aGlzLmJ1Zi5zdWJhcnJheSh0aGlzLnIsIHRoaXMudyksIHAsIDApOwogICAgICAgIHRoaXMuciArPSBjb3BpZWQ7CiAgICAgICAgcmV0dXJuIGNvcGllZDsKICAgIH0KICAgIGFzeW5jIHJlYWRGdWxsKHApIHsKICAgICAgICBsZXQgYnl0ZXNSZWFkID0gMDsKICAgICAgICB3aGlsZShieXRlc1JlYWQgPCBwLmxlbmd0aCl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25zdCByciA9IGF3YWl0IHRoaXMucmVhZChwLnN1YmFycmF5KGJ5dGVzUmVhZCkpOwogICAgICAgICAgICAgICAgaWYgKHJyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ5dGVzUmVhZCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUGFydGlhbFJlYWRFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ5dGVzUmVhZCArPSBycjsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBlcnIucGFydGlhbCA9IHAuc3ViYXJyYXkoMCwgYnl0ZXNSZWFkKTsKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcDsKICAgIH0KICAgIGFzeW5jIHJlYWRCeXRlKCkgewogICAgICAgIHdoaWxlKHRoaXMuciA9PT0gdGhpcy53KXsKICAgICAgICAgICAgaWYgKHRoaXMuZW9mKSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgYXdhaXQgdGhpcy5fZmlsbCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjID0gdGhpcy5idWZbdGhpcy5yXTsKICAgICAgICB0aGlzLnIrKzsKICAgICAgICByZXR1cm4gYzsKICAgIH0KICAgIGFzeW5jIHJlYWRTdHJpbmcoZGVsaW0pIHsKICAgICAgICBpZiAoZGVsaW0ubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRGVsaW1pdGVyIHNob3VsZCBiZSBhIHNpbmdsZSBjaGFyYWN0ZXIiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYnVmZmVyID0gYXdhaXQgdGhpcy5yZWFkU2xpY2UoZGVsaW0uY2hhckNvZGVBdCgwKSk7CiAgICAgICAgaWYgKGJ1ZmZlciA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICAgICAgcmV0dXJuIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShidWZmZXIpOwogICAgfQogICAgYXN5bmMgcmVhZExpbmUoKSB7CiAgICAgICAgbGV0IGxpbmU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGluZSA9IGF3YWl0IHRoaXMucmVhZFNsaWNlKExGKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgbGV0IHsgcGFydGlhbDogcGFydGlhbDEgIH0gPSBlcnI7CiAgICAgICAgICAgIGFzc2VydChwYXJ0aWFsMSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXksICJidWZpbzogY2F1Z2h0IGVycm9yIGZyb20gYHJlYWRTbGljZSgpYCB3aXRob3V0IGBwYXJ0aWFsYCBwcm9wZXJ0eSIpOwogICAgICAgICAgICBpZiAoIShlcnIgaW5zdGFuY2VvZiBCdWZmZXJGdWxsRXJyb3IpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0aGlzLmVvZiAmJiBwYXJ0aWFsMS5ieXRlTGVuZ3RoID4gMCAmJiBwYXJ0aWFsMVtwYXJ0aWFsMS5ieXRlTGVuZ3RoIC0gMV0gPT09IENSKSB7CiAgICAgICAgICAgICAgICBhc3NlcnQodGhpcy5yID4gMCwgImJ1ZmlvOiB0cmllZCB0byByZXdpbmQgcGFzdCBzdGFydCBvZiBidWZmZXIiKTsKICAgICAgICAgICAgICAgIHRoaXMuci0tOwogICAgICAgICAgICAgICAgcGFydGlhbDEgPSBwYXJ0aWFsMS5zdWJhcnJheSgwLCBwYXJ0aWFsMS5ieXRlTGVuZ3RoIC0gMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGxpbmU6IHBhcnRpYWwxLAogICAgICAgICAgICAgICAgbW9yZTogIXRoaXMuZW9mCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGlmIChsaW5lID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAobGluZS5ieXRlTGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBsaW5lLAogICAgICAgICAgICAgICAgbW9yZTogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGxpbmVbbGluZS5ieXRlTGVuZ3RoIC0gMV0gPT0gTEYpIHsKICAgICAgICAgICAgbGV0IGRyb3AgPSAxOwogICAgICAgICAgICBpZiAobGluZS5ieXRlTGVuZ3RoID4gMSAmJiBsaW5lW2xpbmUuYnl0ZUxlbmd0aCAtIDJdID09PSBDUikgewogICAgICAgICAgICAgICAgZHJvcCA9IDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGluZSA9IGxpbmUuc3ViYXJyYXkoMCwgbGluZS5ieXRlTGVuZ3RoIC0gZHJvcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGxpbmUsCiAgICAgICAgICAgIG1vcmU6IGZhbHNlCiAgICAgICAgfTsKICAgIH0KICAgIGFzeW5jIHJlYWRTbGljZShkZWxpbSkgewogICAgICAgIGxldCBzID0gMDsKICAgICAgICBsZXQgc2xpY2U7CiAgICAgICAgd2hpbGUodHJ1ZSl7CiAgICAgICAgICAgIGxldCBpID0gdGhpcy5idWYuc3ViYXJyYXkodGhpcy5yICsgcywgdGhpcy53KS5pbmRleE9mKGRlbGltKTsKICAgICAgICAgICAgaWYgKGkgPj0gMCkgewogICAgICAgICAgICAgICAgaSArPSBzOwogICAgICAgICAgICAgICAgc2xpY2UgPSB0aGlzLmJ1Zi5zdWJhcnJheSh0aGlzLnIsIHRoaXMuciArIGkgKyAxKTsKICAgICAgICAgICAgICAgIHRoaXMuciArPSBpICsgMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmVvZikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuciA9PT0gdGhpcy53KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzbGljZSA9IHRoaXMuYnVmLnN1YmFycmF5KHRoaXMuciwgdGhpcy53KTsKICAgICAgICAgICAgICAgIHRoaXMuciA9IHRoaXMudzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmJ1ZmZlcmVkKCkgPj0gdGhpcy5idWYuYnl0ZUxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpcy5yID0gdGhpcy53OwogICAgICAgICAgICAgICAgY29uc3Qgb2xkYnVmID0gdGhpcy5idWY7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdidWYgPSB0aGlzLmJ1Zi5zbGljZSgwKTsKICAgICAgICAgICAgICAgIHRoaXMuYnVmID0gbmV3YnVmOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEJ1ZmZlckZ1bGxFcnJvcihvbGRidWYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHMgPSB0aGlzLncgLSB0aGlzLnI7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9maWxsKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgZXJyLnBhcnRpYWwgPSBzbGljZTsKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2xpY2U7CiAgICB9CiAgICBhc3luYyBwZWVrKG4pIHsKICAgICAgICBpZiAobiA8IDApIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoIm5lZ2F0aXZlIGNvdW50Iik7CiAgICAgICAgfQogICAgICAgIGxldCBhdmFpbCA9IHRoaXMudyAtIHRoaXMucjsKICAgICAgICB3aGlsZShhdmFpbCA8IG4gJiYgYXZhaWwgPCB0aGlzLmJ1Zi5ieXRlTGVuZ3RoICYmICF0aGlzLmVvZil7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9maWxsKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgZXJyLnBhcnRpYWwgPSB0aGlzLmJ1Zi5zdWJhcnJheSh0aGlzLnIsIHRoaXMudyk7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXZhaWwgPSB0aGlzLncgLSB0aGlzLnI7CiAgICAgICAgfQogICAgICAgIGlmIChhdmFpbCA9PT0gMCAmJiB0aGlzLmVvZikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9IGVsc2UgaWYgKGF2YWlsIDwgbiAmJiB0aGlzLmVvZikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5idWYuc3ViYXJyYXkodGhpcy5yLCB0aGlzLnIgKyBhdmFpbCk7CiAgICAgICAgfSBlbHNlIGlmIChhdmFpbCA8IG4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEJ1ZmZlckZ1bGxFcnJvcih0aGlzLmJ1Zi5zdWJhcnJheSh0aGlzLnIsIHRoaXMudykpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5idWYuc3ViYXJyYXkodGhpcy5yLCB0aGlzLnIgKyBuKTsKICAgIH0KfQpjb25zdCBCdWZSZWFkZXIxID0gQnVmUmVhZGVyOwpjbGFzcyBBYnN0cmFjdEJ1ZkJhc2UgewogICAgdXNlZEJ1ZmZlckJ5dGVzID0gMDsKICAgIGVyciA9IG51bGw7CiAgICBzaXplKCkgewogICAgICAgIHJldHVybiB0aGlzLmJ1Zi5ieXRlTGVuZ3RoOwogICAgfQogICAgYXZhaWxhYmxlKCkgewogICAgICAgIHJldHVybiB0aGlzLmJ1Zi5ieXRlTGVuZ3RoIC0gdGhpcy51c2VkQnVmZmVyQnl0ZXM7CiAgICB9CiAgICBidWZmZXJlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy51c2VkQnVmZmVyQnl0ZXM7CiAgICB9Cn0KY2xhc3MgQnVmV3JpdGVyIGV4dGVuZHMgQWJzdHJhY3RCdWZCYXNlIHsKICAgIHN0YXRpYyBjcmVhdGUod3JpdGVyLCBzaXplID0gNDA5NikgewogICAgICAgIHJldHVybiB3cml0ZXIgaW5zdGFuY2VvZiBCdWZXcml0ZXIgPyB3cml0ZXIgOiBuZXcgQnVmV3JpdGVyKHdyaXRlciwgc2l6ZSk7CiAgICB9CiAgICBjb25zdHJ1Y3Rvcih3cml0ZXIxLCBzaXplMiA9IDQwOTYpewogICAgICAgIHN1cGVyKCk7CiAgICAgICAgdGhpcy53cml0ZXIgPSB3cml0ZXIxOwogICAgICAgIGlmIChzaXplMiA8PSAwKSB7CiAgICAgICAgICAgIHNpemUyID0gREVGQVVMVF9CVUZfU0laRTsKICAgICAgICB9CiAgICAgICAgdGhpcy5idWYgPSBuZXcgVWludDhBcnJheShzaXplMik7CiAgICB9CiAgICByZXNldCh3KSB7CiAgICAgICAgdGhpcy5lcnIgPSBudWxsOwogICAgICAgIHRoaXMudXNlZEJ1ZmZlckJ5dGVzID0gMDsKICAgICAgICB0aGlzLndyaXRlciA9IHc7CiAgICB9CiAgICBhc3luYyBmbHVzaCgpIHsKICAgICAgICBpZiAodGhpcy5lcnIgIT09IG51bGwpIHRocm93IHRoaXMuZXJyOwogICAgICAgIGlmICh0aGlzLnVzZWRCdWZmZXJCeXRlcyA9PT0gMCkgcmV0dXJuOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IERlbm8ud3JpdGVBbGwodGhpcy53cml0ZXIsIHRoaXMuYnVmLnN1YmFycmF5KDAsIHRoaXMudXNlZEJ1ZmZlckJ5dGVzKSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmVyciA9IGU7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIHRoaXMuYnVmID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5idWYubGVuZ3RoKTsKICAgICAgICB0aGlzLnVzZWRCdWZmZXJCeXRlcyA9IDA7CiAgICB9CiAgICBhc3luYyB3cml0ZShkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuZXJyICE9PSBudWxsKSB0aHJvdyB0aGlzLmVycjsKICAgICAgICBpZiAoZGF0YS5sZW5ndGggPT09IDApIHJldHVybiAwOwogICAgICAgIGxldCB0b3RhbEJ5dGVzV3JpdHRlbiA9IDA7CiAgICAgICAgbGV0IG51bUJ5dGVzV3JpdHRlbiA9IDA7CiAgICAgICAgd2hpbGUoZGF0YS5ieXRlTGVuZ3RoID4gdGhpcy5hdmFpbGFibGUoKSl7CiAgICAgICAgICAgIGlmICh0aGlzLmJ1ZmZlcmVkKCkgPT09IDApIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgbnVtQnl0ZXNXcml0dGVuID0gYXdhaXQgdGhpcy53cml0ZXIud3JpdGUoZGF0YSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lcnIgPSBlOwogICAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBudW1CeXRlc1dyaXR0ZW4gPSBjb3B5MShkYXRhLCB0aGlzLmJ1ZiwgdGhpcy51c2VkQnVmZmVyQnl0ZXMpOwogICAgICAgICAgICAgICAgdGhpcy51c2VkQnVmZmVyQnl0ZXMgKz0gbnVtQnl0ZXNXcml0dGVuOwogICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5mbHVzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRvdGFsQnl0ZXNXcml0dGVuICs9IG51bUJ5dGVzV3JpdHRlbjsKICAgICAgICAgICAgZGF0YSA9IGRhdGEuc3ViYXJyYXkobnVtQnl0ZXNXcml0dGVuKTsKICAgICAgICB9CiAgICAgICAgbnVtQnl0ZXNXcml0dGVuID0gY29weTEoZGF0YSwgdGhpcy5idWYsIHRoaXMudXNlZEJ1ZmZlckJ5dGVzKTsKICAgICAgICB0aGlzLnVzZWRCdWZmZXJCeXRlcyArPSBudW1CeXRlc1dyaXR0ZW47CiAgICAgICAgdG90YWxCeXRlc1dyaXR0ZW4gKz0gbnVtQnl0ZXNXcml0dGVuOwogICAgICAgIHJldHVybiB0b3RhbEJ5dGVzV3JpdHRlbjsKICAgIH0KfQpjb25zdCBCdWZXcml0ZXIxID0gQnVmV3JpdGVyOwpjbGFzcyBCdWZXcml0ZXJTeW5jIGV4dGVuZHMgQWJzdHJhY3RCdWZCYXNlIHsKICAgIHN0YXRpYyBjcmVhdGUod3JpdGVyLCBzaXplID0gNDA5NikgewogICAgICAgIHJldHVybiB3cml0ZXIgaW5zdGFuY2VvZiBCdWZXcml0ZXJTeW5jID8gd3JpdGVyIDogbmV3IEJ1ZldyaXRlclN5bmMod3JpdGVyLCBzaXplKTsKICAgIH0KICAgIGNvbnN0cnVjdG9yKHdyaXRlcjIsIHNpemUzID0gNDA5Nil7CiAgICAgICAgc3VwZXIoKTsKICAgICAgICB0aGlzLndyaXRlciA9IHdyaXRlcjI7CiAgICAgICAgaWYgKHNpemUzIDw9IDApIHsKICAgICAgICAgICAgc2l6ZTMgPSBERUZBVUxUX0JVRl9TSVpFOwogICAgICAgIH0KICAgICAgICB0aGlzLmJ1ZiA9IG5ldyBVaW50OEFycmF5KHNpemUzKTsKICAgIH0KICAgIHJlc2V0KHcpIHsKICAgICAgICB0aGlzLmVyciA9IG51bGw7CiAgICAgICAgdGhpcy51c2VkQnVmZmVyQnl0ZXMgPSAwOwogICAgICAgIHRoaXMud3JpdGVyID0gdzsKICAgIH0KICAgIGZsdXNoKCkgewogICAgICAgIGlmICh0aGlzLmVyciAhPT0gbnVsbCkgdGhyb3cgdGhpcy5lcnI7CiAgICAgICAgaWYgKHRoaXMudXNlZEJ1ZmZlckJ5dGVzID09PSAwKSByZXR1cm47CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgRGVuby53cml0ZUFsbFN5bmModGhpcy53cml0ZXIsIHRoaXMuYnVmLnN1YmFycmF5KDAsIHRoaXMudXNlZEJ1ZmZlckJ5dGVzKSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmVyciA9IGU7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIHRoaXMuYnVmID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5idWYubGVuZ3RoKTsKICAgICAgICB0aGlzLnVzZWRCdWZmZXJCeXRlcyA9IDA7CiAgICB9CiAgICB3cml0ZVN5bmMoZGF0YSkgewogICAgICAgIGlmICh0aGlzLmVyciAhPT0gbnVsbCkgdGhyb3cgdGhpcy5lcnI7CiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID09PSAwKSByZXR1cm4gMDsKICAgICAgICBsZXQgdG90YWxCeXRlc1dyaXR0ZW4gPSAwOwogICAgICAgIGxldCBudW1CeXRlc1dyaXR0ZW4gPSAwOwogICAgICAgIHdoaWxlKGRhdGEuYnl0ZUxlbmd0aCA+IHRoaXMuYXZhaWxhYmxlKCkpewogICAgICAgICAgICBpZiAodGhpcy5idWZmZXJlZCgpID09PSAwKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG51bUJ5dGVzV3JpdHRlbiA9IHRoaXMud3JpdGVyLndyaXRlU3luYyhkYXRhKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVyciA9IGU7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG51bUJ5dGVzV3JpdHRlbiA9IGNvcHkxKGRhdGEsIHRoaXMuYnVmLCB0aGlzLnVzZWRCdWZmZXJCeXRlcyk7CiAgICAgICAgICAgICAgICB0aGlzLnVzZWRCdWZmZXJCeXRlcyArPSBudW1CeXRlc1dyaXR0ZW47CiAgICAgICAgICAgICAgICB0aGlzLmZsdXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdG90YWxCeXRlc1dyaXR0ZW4gKz0gbnVtQnl0ZXNXcml0dGVuOwogICAgICAgICAgICBkYXRhID0gZGF0YS5zdWJhcnJheShudW1CeXRlc1dyaXR0ZW4pOwogICAgICAgIH0KICAgICAgICBudW1CeXRlc1dyaXR0ZW4gPSBjb3B5MShkYXRhLCB0aGlzLmJ1ZiwgdGhpcy51c2VkQnVmZmVyQnl0ZXMpOwogICAgICAgIHRoaXMudXNlZEJ1ZmZlckJ5dGVzICs9IG51bUJ5dGVzV3JpdHRlbjsKICAgICAgICB0b3RhbEJ5dGVzV3JpdHRlbiArPSBudW1CeXRlc1dyaXR0ZW47CiAgICAgICAgcmV0dXJuIHRvdGFsQnl0ZXNXcml0dGVuOwogICAgfQp9CmZ1bmN0aW9uIGNyZWF0ZUxQUyhwYXQpIHsKICAgIGNvbnN0IGxwcyA9IG5ldyBVaW50OEFycmF5KHBhdC5sZW5ndGgpOwogICAgbHBzWzBdID0gMDsKICAgIGxldCBwcmVmaXhFbmQgPSAwOwogICAgbGV0IGkgPSAxOwogICAgd2hpbGUoaSA8IGxwcy5sZW5ndGgpewogICAgICAgIGlmIChwYXRbaV0gPT0gcGF0W3ByZWZpeEVuZF0pIHsKICAgICAgICAgICAgcHJlZml4RW5kKys7CiAgICAgICAgICAgIGxwc1tpXSA9IHByZWZpeEVuZDsKICAgICAgICAgICAgaSsrOwogICAgICAgIH0gZWxzZSBpZiAocHJlZml4RW5kID09PSAwKSB7CiAgICAgICAgICAgIGxwc1tpXSA9IDA7CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcmVmaXhFbmQgPSBwYXRbcHJlZml4RW5kIC0gMV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGxwczsKfQphc3luYyBmdW5jdGlvbiogcmVhZERlbGltKHJlYWRlciwgZGVsaW0pIHsKICAgIGNvbnN0IGRlbGltTGVuID0gZGVsaW0ubGVuZ3RoOwogICAgY29uc3QgZGVsaW1MUFMgPSBjcmVhdGVMUFMoZGVsaW0pOwogICAgbGV0IGlucHV0QnVmZmVyID0gbmV3IERlbm8uQnVmZmVyKCk7CiAgICBjb25zdCBpbnNwZWN0QXJyID0gbmV3IFVpbnQ4QXJyYXkoTWF0aC5tYXgoMTAyNCwgZGVsaW1MZW4gKyAxKSk7CiAgICBsZXQgaW5zcGVjdEluZGV4ID0gMDsKICAgIGxldCBtYXRjaEluZGV4ID0gMDsKICAgIHdoaWxlKHRydWUpewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlYWRlci5yZWFkKGluc3BlY3RBcnIpOwogICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgICAgeWllbGQgaW5wdXRCdWZmZXIuYnl0ZXMoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAocmVzdWx0IDwgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNsaWNlUmVhZCA9IGluc3BlY3RBcnIuc3ViYXJyYXkoMCwgcmVzdWx0KTsKICAgICAgICBhd2FpdCBEZW5vLndyaXRlQWxsKGlucHV0QnVmZmVyLCBzbGljZVJlYWQpOwogICAgICAgIGxldCBzbGljZVRvUHJvY2VzcyA9IGlucHV0QnVmZmVyLmJ5dGVzKCk7CiAgICAgICAgd2hpbGUoaW5zcGVjdEluZGV4IDwgc2xpY2VUb1Byb2Nlc3MubGVuZ3RoKXsKICAgICAgICAgICAgaWYgKHNsaWNlVG9Qcm9jZXNzW2luc3BlY3RJbmRleF0gPT09IGRlbGltW21hdGNoSW5kZXhdKSB7CiAgICAgICAgICAgICAgICBpbnNwZWN0SW5kZXgrKzsKICAgICAgICAgICAgICAgIG1hdGNoSW5kZXgrKzsKICAgICAgICAgICAgICAgIGlmIChtYXRjaEluZGV4ID09PSBkZWxpbUxlbikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoRW5kID0gaW5zcGVjdEluZGV4IC0gZGVsaW1MZW47CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhZHlCeXRlcyA9IHNsaWNlVG9Qcm9jZXNzLnN1YmFycmF5KDAsIG1hdGNoRW5kKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZW5kaW5nQnl0ZXMgPSBzbGljZVRvUHJvY2Vzcy5zbGljZShpbnNwZWN0SW5kZXgpOwogICAgICAgICAgICAgICAgICAgIHlpZWxkIHJlYWR5Qnl0ZXM7CiAgICAgICAgICAgICAgICAgICAgc2xpY2VUb1Byb2Nlc3MgPSBwZW5kaW5nQnl0ZXM7CiAgICAgICAgICAgICAgICAgICAgaW5zcGVjdEluZGV4ID0gMDsKICAgICAgICAgICAgICAgICAgICBtYXRjaEluZGV4ID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaEluZGV4ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5zcGVjdEluZGV4Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1hdGNoSW5kZXggPSBkZWxpbUxQU1ttYXRjaEluZGV4IC0gMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaW5wdXRCdWZmZXIgPSBuZXcgRGVuby5CdWZmZXIoc2xpY2VUb1Byb2Nlc3MpOwogICAgfQp9CmFzeW5jIGZ1bmN0aW9uKiByZWFkU3RyaW5nRGVsaW0ocmVhZGVyLCBkZWxpbSkgewogICAgY29uc3QgZW5jb2RlcjIgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgIGNvbnN0IGRlY29kZXIxID0gbmV3IFRleHREZWNvZGVyKCk7CiAgICBmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIHJlYWREZWxpbShyZWFkZXIsIGVuY29kZXIyLmVuY29kZShkZWxpbSkpKXsKICAgICAgICB5aWVsZCBkZWNvZGVyMS5kZWNvZGUoY2h1bmspOwogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIHdyaXRlVHJhaWxlcnModywgaGVhZGVycywgdHJhaWxlcnMpIHsKICAgIGNvbnN0IHRyYWlsZXIgPSBoZWFkZXJzLmdldCgidHJhaWxlciIpOwogICAgaWYgKHRyYWlsZXIgPT09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJNaXNzaW5nIHRyYWlsZXIgaGVhZGVyLiIpOwogICAgfQogICAgY29uc3QgdHJhbnNmZXJFbmNvZGluZyA9IGhlYWRlcnMuZ2V0KCJ0cmFuc2Zlci1lbmNvZGluZyIpOwogICAgaWYgKHRyYW5zZmVyRW5jb2RpbmcgPT09IG51bGwgfHwgIXRyYW5zZmVyRW5jb2RpbmcubWF0Y2goL15jaHVua2VkLykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBUcmFpbGVycyBhcmUgb25seSBhbGxvd2VkIGZvciAidHJhbnNmZXItZW5jb2Rpbmc6IGNodW5rZWQiLCBnb3QgInRyYW5zZmVyLWVuY29kaW5nOiAke3RyYW5zZmVyRW5jb2Rpbmd9Ii5gKTsKICAgIH0KICAgIGNvbnN0IHdyaXRlcjMgPSBCdWZXcml0ZXIuY3JlYXRlKHcpOwogICAgY29uc3QgdHJhaWxlck5hbWVzID0gdHJhaWxlci5zcGxpdCgiLCIpLm1hcCgocyk9PnMudHJpbSgpLnRvTG93ZXJDYXNlKCkKICAgICk7CiAgICBjb25zdCBwcm9oaWJpdGVkVHJhaWxlcnMgPSB0cmFpbGVyTmFtZXMuZmlsdGVyKChrKT0+aXNQcm9oaWJpZGVkRm9yVHJhaWxlcihrKQogICAgKTsKICAgIGlmIChwcm9oaWJpdGVkVHJhaWxlcnMubGVuZ3RoID4gMCkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYFByb2hpYml0ZWQgdHJhaWxlciBuYW1lczogJHtEZW5vLmluc3BlY3QocHJvaGliaXRlZFRyYWlsZXJzKX0uYCk7CiAgICB9CiAgICBjb25zdCB1bmRlY2xhcmVkID0gWwogICAgICAgIC4uLnRyYWlsZXJzLmtleXMoKQogICAgXS5maWx0ZXIoKGspPT4hdHJhaWxlck5hbWVzLmluY2x1ZGVzKGspCiAgICApOwogICAgaWYgKHVuZGVjbGFyZWQubGVuZ3RoID4gMCkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYFVuZGVjbGFyZWQgdHJhaWxlcnM6ICR7RGVuby5pbnNwZWN0KHVuZGVjbGFyZWQpfS5gKTsKICAgIH0KICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHRyYWlsZXJzKXsKICAgICAgICBhd2FpdCB3cml0ZXIzLndyaXRlKGVuY29kZXIuZW5jb2RlKGAke2tleX06ICR7dmFsdWV9XHJcbmApKTsKICAgIH0KICAgIGF3YWl0IHdyaXRlcjMud3JpdGUoZW5jb2Rlci5lbmNvZGUoIlxyXG4iKSk7CiAgICBhd2FpdCB3cml0ZXIzLmZsdXNoKCk7Cn0KdmFyIFN0YXR1czsKKGZ1bmN0aW9uKFN0YXR1czEpIHsKICAgIFN0YXR1czFbU3RhdHVzMVsiQ29udGludWUiXSA9IDEwMF0gPSAiQ29udGludWUiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJTd2l0Y2hpbmdQcm90b2NvbHMiXSA9IDEwMV0gPSAiU3dpdGNoaW5nUHJvdG9jb2xzIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiUHJvY2Vzc2luZyJdID0gMTAyXSA9ICJQcm9jZXNzaW5nIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiRWFybHlIaW50cyJdID0gMTAzXSA9ICJFYXJseUhpbnRzIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiT0siXSA9IDIwMF0gPSAiT0siOwogICAgU3RhdHVzMVtTdGF0dXMxWyJDcmVhdGVkIl0gPSAyMDFdID0gIkNyZWF0ZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJBY2NlcHRlZCJdID0gMjAyXSA9ICJBY2NlcHRlZCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIk5vbkF1dGhvcml0YXRpdmVJbmZvIl0gPSAyMDNdID0gIk5vbkF1dGhvcml0YXRpdmVJbmZvIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiTm9Db250ZW50Il0gPSAyMDRdID0gIk5vQ29udGVudCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlJlc2V0Q29udGVudCJdID0gMjA1XSA9ICJSZXNldENvbnRlbnQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJQYXJ0aWFsQ29udGVudCJdID0gMjA2XSA9ICJQYXJ0aWFsQ29udGVudCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIk11bHRpU3RhdHVzIl0gPSAyMDddID0gIk11bHRpU3RhdHVzIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiQWxyZWFkeVJlcG9ydGVkIl0gPSAyMDhdID0gIkFscmVhZHlSZXBvcnRlZCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIklNVXNlZCJdID0gMjI2XSA9ICJJTVVzZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJNdWx0aXBsZUNob2ljZXMiXSA9IDMwMF0gPSAiTXVsdGlwbGVDaG9pY2VzIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiTW92ZWRQZXJtYW5lbnRseSJdID0gMzAxXSA9ICJNb3ZlZFBlcm1hbmVudGx5IjsKICAgIFN0YXR1czFbU3RhdHVzMVsiRm91bmQiXSA9IDMwMl0gPSAiRm91bmQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJTZWVPdGhlciJdID0gMzAzXSA9ICJTZWVPdGhlciI7CiAgICBTdGF0dXMxW1N0YXR1czFbIk5vdE1vZGlmaWVkIl0gPSAzMDRdID0gIk5vdE1vZGlmaWVkIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiVXNlUHJveHkiXSA9IDMwNV0gPSAiVXNlUHJveHkiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJUZW1wb3JhcnlSZWRpcmVjdCJdID0gMzA3XSA9ICJUZW1wb3JhcnlSZWRpcmVjdCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlBlcm1hbmVudFJlZGlyZWN0Il0gPSAzMDhdID0gIlBlcm1hbmVudFJlZGlyZWN0IjsKICAgIFN0YXR1czFbU3RhdHVzMVsiQmFkUmVxdWVzdCJdID0gNDAwXSA9ICJCYWRSZXF1ZXN0IjsKICAgIFN0YXR1czFbU3RhdHVzMVsiVW5hdXRob3JpemVkIl0gPSA0MDFdID0gIlVuYXV0aG9yaXplZCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlBheW1lbnRSZXF1aXJlZCJdID0gNDAyXSA9ICJQYXltZW50UmVxdWlyZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJGb3JiaWRkZW4iXSA9IDQwM10gPSAiRm9yYmlkZGVuIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiTm90Rm91bmQiXSA9IDQwNF0gPSAiTm90Rm91bmQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJNZXRob2ROb3RBbGxvd2VkIl0gPSA0MDVdID0gIk1ldGhvZE5vdEFsbG93ZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJOb3RBY2NlcHRhYmxlIl0gPSA0MDZdID0gIk5vdEFjY2VwdGFibGUiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJQcm94eUF1dGhSZXF1aXJlZCJdID0gNDA3XSA9ICJQcm94eUF1dGhSZXF1aXJlZCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlJlcXVlc3RUaW1lb3V0Il0gPSA0MDhdID0gIlJlcXVlc3RUaW1lb3V0IjsKICAgIFN0YXR1czFbU3RhdHVzMVsiQ29uZmxpY3QiXSA9IDQwOV0gPSAiQ29uZmxpY3QiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJHb25lIl0gPSA0MTBdID0gIkdvbmUiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJMZW5ndGhSZXF1aXJlZCJdID0gNDExXSA9ICJMZW5ndGhSZXF1aXJlZCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlByZWNvbmRpdGlvbkZhaWxlZCJdID0gNDEyXSA9ICJQcmVjb25kaXRpb25GYWlsZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJSZXF1ZXN0RW50aXR5VG9vTGFyZ2UiXSA9IDQxM10gPSAiUmVxdWVzdEVudGl0eVRvb0xhcmdlIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiUmVxdWVzdFVSSVRvb0xvbmciXSA9IDQxNF0gPSAiUmVxdWVzdFVSSVRvb0xvbmciOwogICAgU3RhdHVzMVtTdGF0dXMxWyJVbnN1cHBvcnRlZE1lZGlhVHlwZSJdID0gNDE1XSA9ICJVbnN1cHBvcnRlZE1lZGlhVHlwZSI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlJlcXVlc3RlZFJhbmdlTm90U2F0aXNmaWFibGUiXSA9IDQxNl0gPSAiUmVxdWVzdGVkUmFuZ2VOb3RTYXRpc2ZpYWJsZSI7CiAgICBTdGF0dXMxW1N0YXR1czFbIkV4cGVjdGF0aW9uRmFpbGVkIl0gPSA0MTddID0gIkV4cGVjdGF0aW9uRmFpbGVkIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiVGVhcG90Il0gPSA0MThdID0gIlRlYXBvdCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIk1pc2RpcmVjdGVkUmVxdWVzdCJdID0gNDIxXSA9ICJNaXNkaXJlY3RlZFJlcXVlc3QiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJVbnByb2Nlc3NhYmxlRW50aXR5Il0gPSA0MjJdID0gIlVucHJvY2Vzc2FibGVFbnRpdHkiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJMb2NrZWQiXSA9IDQyM10gPSAiTG9ja2VkIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiRmFpbGVkRGVwZW5kZW5jeSJdID0gNDI0XSA9ICJGYWlsZWREZXBlbmRlbmN5IjsKICAgIFN0YXR1czFbU3RhdHVzMVsiVG9vRWFybHkiXSA9IDQyNV0gPSAiVG9vRWFybHkiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJVcGdyYWRlUmVxdWlyZWQiXSA9IDQyNl0gPSAiVXBncmFkZVJlcXVpcmVkIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiUHJlY29uZGl0aW9uUmVxdWlyZWQiXSA9IDQyOF0gPSAiUHJlY29uZGl0aW9uUmVxdWlyZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJUb29NYW55UmVxdWVzdHMiXSA9IDQyOV0gPSAiVG9vTWFueVJlcXVlc3RzIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiUmVxdWVzdEhlYWRlckZpZWxkc1Rvb0xhcmdlIl0gPSA0MzFdID0gIlJlcXVlc3RIZWFkZXJGaWVsZHNUb29MYXJnZSI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlVuYXZhaWxhYmxlRm9yTGVnYWxSZWFzb25zIl0gPSA0NTFdID0gIlVuYXZhaWxhYmxlRm9yTGVnYWxSZWFzb25zIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiSW50ZXJuYWxTZXJ2ZXJFcnJvciJdID0gNTAwXSA9ICJJbnRlcm5hbFNlcnZlckVycm9yIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiTm90SW1wbGVtZW50ZWQiXSA9IDUwMV0gPSAiTm90SW1wbGVtZW50ZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJCYWRHYXRld2F5Il0gPSA1MDJdID0gIkJhZEdhdGV3YXkiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJTZXJ2aWNlVW5hdmFpbGFibGUiXSA9IDUwM10gPSAiU2VydmljZVVuYXZhaWxhYmxlIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiR2F0ZXdheVRpbWVvdXQiXSA9IDUwNF0gPSAiR2F0ZXdheVRpbWVvdXQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJIVFRQVmVyc2lvbk5vdFN1cHBvcnRlZCJdID0gNTA1XSA9ICJIVFRQVmVyc2lvbk5vdFN1cHBvcnRlZCI7CiAgICBTdGF0dXMxW1N0YXR1czFbIlZhcmlhbnRBbHNvTmVnb3RpYXRlcyJdID0gNTA2XSA9ICJWYXJpYW50QWxzb05lZ290aWF0ZXMiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJJbnN1ZmZpY2llbnRTdG9yYWdlIl0gPSA1MDddID0gIkluc3VmZmljaWVudFN0b3JhZ2UiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJMb29wRGV0ZWN0ZWQiXSA9IDUwOF0gPSAiTG9vcERldGVjdGVkIjsKICAgIFN0YXR1czFbU3RhdHVzMVsiTm90RXh0ZW5kZWQiXSA9IDUxMF0gPSAiTm90RXh0ZW5kZWQiOwogICAgU3RhdHVzMVtTdGF0dXMxWyJOZXR3b3JrQXV0aGVudGljYXRpb25SZXF1aXJlZCJdID0gNTExXSA9ICJOZXR3b3JrQXV0aGVudGljYXRpb25SZXF1aXJlZCI7Cn0pKFN0YXR1cyB8fCAoU3RhdHVzID0gewp9KSk7CmNvbnN0IFNUQVRVU19URVhUID0gbmV3IE1hcChbCiAgICBbCiAgICAgICAgU3RhdHVzLkNvbnRpbnVlLAogICAgICAgICJDb250aW51ZSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlN3aXRjaGluZ1Byb3RvY29scywKICAgICAgICAiU3dpdGNoaW5nIFByb3RvY29scyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlByb2Nlc3NpbmcsCiAgICAgICAgIlByb2Nlc3NpbmciCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5FYXJseUhpbnRzLAogICAgICAgICJFYXJseSBIaW50cyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLk9LLAogICAgICAgICJPSyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLkNyZWF0ZWQsCiAgICAgICAgIkNyZWF0ZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5BY2NlcHRlZCwKICAgICAgICAiQWNjZXB0ZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5Ob25BdXRob3JpdGF0aXZlSW5mbywKICAgICAgICAiTm9uLUF1dGhvcml0YXRpdmUgSW5mb3JtYXRpb24iCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5Ob0NvbnRlbnQsCiAgICAgICAgIk5vIENvbnRlbnQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5SZXNldENvbnRlbnQsCiAgICAgICAgIlJlc2V0IENvbnRlbnQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5QYXJ0aWFsQ29udGVudCwKICAgICAgICAiUGFydGlhbCBDb250ZW50IgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuTXVsdGlTdGF0dXMsCiAgICAgICAgIk11bHRpLVN0YXR1cyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLkFscmVhZHlSZXBvcnRlZCwKICAgICAgICAiQWxyZWFkeSBSZXBvcnRlZCIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLklNVXNlZCwKICAgICAgICAiSU0gVXNlZCIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLk11bHRpcGxlQ2hvaWNlcywKICAgICAgICAiTXVsdGlwbGUgQ2hvaWNlcyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLk1vdmVkUGVybWFuZW50bHksCiAgICAgICAgIk1vdmVkIFBlcm1hbmVudGx5IgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuRm91bmQsCiAgICAgICAgIkZvdW5kIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuU2VlT3RoZXIsCiAgICAgICAgIlNlZSBPdGhlciIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLk5vdE1vZGlmaWVkLAogICAgICAgICJOb3QgTW9kaWZpZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5Vc2VQcm94eSwKICAgICAgICAiVXNlIFByb3h5IgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuVGVtcG9yYXJ5UmVkaXJlY3QsCiAgICAgICAgIlRlbXBvcmFyeSBSZWRpcmVjdCIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlBlcm1hbmVudFJlZGlyZWN0LAogICAgICAgICJQZXJtYW5lbnQgUmVkaXJlY3QiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5CYWRSZXF1ZXN0LAogICAgICAgICJCYWQgUmVxdWVzdCIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlVuYXV0aG9yaXplZCwKICAgICAgICAiVW5hdXRob3JpemVkIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuUGF5bWVudFJlcXVpcmVkLAogICAgICAgICJQYXltZW50IFJlcXVpcmVkIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuRm9yYmlkZGVuLAogICAgICAgICJGb3JiaWRkZW4iCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5Ob3RGb3VuZCwKICAgICAgICAiTm90IEZvdW5kIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuTWV0aG9kTm90QWxsb3dlZCwKICAgICAgICAiTWV0aG9kIE5vdCBBbGxvd2VkIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuTm90QWNjZXB0YWJsZSwKICAgICAgICAiTm90IEFjY2VwdGFibGUiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5Qcm94eUF1dGhSZXF1aXJlZCwKICAgICAgICAiUHJveHkgQXV0aGVudGljYXRpb24gUmVxdWlyZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5SZXF1ZXN0VGltZW91dCwKICAgICAgICAiUmVxdWVzdCBUaW1lb3V0IgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuQ29uZmxpY3QsCiAgICAgICAgIkNvbmZsaWN0IgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuR29uZSwKICAgICAgICAiR29uZSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLkxlbmd0aFJlcXVpcmVkLAogICAgICAgICJMZW5ndGggUmVxdWlyZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5QcmVjb25kaXRpb25GYWlsZWQsCiAgICAgICAgIlByZWNvbmRpdGlvbiBGYWlsZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5SZXF1ZXN0RW50aXR5VG9vTGFyZ2UsCiAgICAgICAgIlJlcXVlc3QgRW50aXR5IFRvbyBMYXJnZSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlJlcXVlc3RVUklUb29Mb25nLAogICAgICAgICJSZXF1ZXN0IFVSSSBUb28gTG9uZyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlVuc3VwcG9ydGVkTWVkaWFUeXBlLAogICAgICAgICJVbnN1cHBvcnRlZCBNZWRpYSBUeXBlIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuUmVxdWVzdGVkUmFuZ2VOb3RTYXRpc2ZpYWJsZSwKICAgICAgICAiUmVxdWVzdGVkIFJhbmdlIE5vdCBTYXRpc2ZpYWJsZSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLkV4cGVjdGF0aW9uRmFpbGVkLAogICAgICAgICJFeHBlY3RhdGlvbiBGYWlsZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5UZWFwb3QsCiAgICAgICAgIkknbSBhIHRlYXBvdCIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLk1pc2RpcmVjdGVkUmVxdWVzdCwKICAgICAgICAiTWlzZGlyZWN0ZWQgUmVxdWVzdCIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlVucHJvY2Vzc2FibGVFbnRpdHksCiAgICAgICAgIlVucHJvY2Vzc2FibGUgRW50aXR5IgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuTG9ja2VkLAogICAgICAgICJMb2NrZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5GYWlsZWREZXBlbmRlbmN5LAogICAgICAgICJGYWlsZWQgRGVwZW5kZW5jeSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlRvb0Vhcmx5LAogICAgICAgICJUb28gRWFybHkiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5VcGdyYWRlUmVxdWlyZWQsCiAgICAgICAgIlVwZ3JhZGUgUmVxdWlyZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5QcmVjb25kaXRpb25SZXF1aXJlZCwKICAgICAgICAiUHJlY29uZGl0aW9uIFJlcXVpcmVkIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuVG9vTWFueVJlcXVlc3RzLAogICAgICAgICJUb28gTWFueSBSZXF1ZXN0cyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlJlcXVlc3RIZWFkZXJGaWVsZHNUb29MYXJnZSwKICAgICAgICAiUmVxdWVzdCBIZWFkZXIgRmllbGRzIFRvbyBMYXJnZSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlVuYXZhaWxhYmxlRm9yTGVnYWxSZWFzb25zLAogICAgICAgICJVbmF2YWlsYWJsZSBGb3IgTGVnYWwgUmVhc29ucyIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLkludGVybmFsU2VydmVyRXJyb3IsCiAgICAgICAgIkludGVybmFsIFNlcnZlciBFcnJvciIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLk5vdEltcGxlbWVudGVkLAogICAgICAgICJOb3QgSW1wbGVtZW50ZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5CYWRHYXRld2F5LAogICAgICAgICJCYWQgR2F0ZXdheSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLlNlcnZpY2VVbmF2YWlsYWJsZSwKICAgICAgICAiU2VydmljZSBVbmF2YWlsYWJsZSIKICAgIF0sCiAgICBbCiAgICAgICAgU3RhdHVzLkdhdGV3YXlUaW1lb3V0LAogICAgICAgICJHYXRld2F5IFRpbWVvdXQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5IVFRQVmVyc2lvbk5vdFN1cHBvcnRlZCwKICAgICAgICAiSFRUUCBWZXJzaW9uIE5vdCBTdXBwb3J0ZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5WYXJpYW50QWxzb05lZ290aWF0ZXMsCiAgICAgICAgIlZhcmlhbnQgQWxzbyBOZWdvdGlhdGVzIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuSW5zdWZmaWNpZW50U3RvcmFnZSwKICAgICAgICAiSW5zdWZmaWNpZW50IFN0b3JhZ2UiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5Mb29wRGV0ZWN0ZWQsCiAgICAgICAgIkxvb3AgRGV0ZWN0ZWQiCiAgICBdLAogICAgWwogICAgICAgIFN0YXR1cy5Ob3RFeHRlbmRlZCwKICAgICAgICAiTm90IEV4dGVuZGVkIgogICAgXSwKICAgIFsKICAgICAgICBTdGF0dXMuTmV0d29ya0F1dGhlbnRpY2F0aW9uUmVxdWlyZWQsCiAgICAgICAgIk5ldHdvcmsgQXV0aGVudGljYXRpb24gUmVxdWlyZWQiCiAgICBdLCAKXSk7CmFzeW5jIGZ1bmN0aW9uIHdyaXRlUmVzcG9uc2UodywgcjIpIHsKICAgIGNvbnN0IHByb3RvTWFqb3IgPSAxOwogICAgY29uc3QgcHJvdG9NaW5vciA9IDE7CiAgICBjb25zdCBzdGF0dXNDb2RlID0gcjIuc3RhdHVzIHx8IDIwMDsKICAgIGNvbnN0IHN0YXR1c1RleHQgPSBTVEFUVVNfVEVYVC5nZXQoc3RhdHVzQ29kZSk7CiAgICBjb25zdCB3cml0ZXIzID0gQnVmV3JpdGVyLmNyZWF0ZSh3KTsKICAgIGlmICghc3RhdHVzVGV4dCkgewogICAgICAgIHRocm93IG5ldyBEZW5vLmVycm9ycy5JbnZhbGlkRGF0YSgiQmFkIHN0YXR1cyBjb2RlIik7CiAgICB9CiAgICBpZiAoIXIyLmJvZHkpIHsKICAgICAgICByMi5ib2R5ID0gbmV3IFVpbnQ4QXJyYXkoKTsKICAgIH0KICAgIGlmICh0eXBlb2YgcjIuYm9keSA9PT0gInN0cmluZyIpIHsKICAgICAgICByMi5ib2R5ID0gZW5jb2RlcjEuZW5jb2RlKHIyLmJvZHkpOwogICAgfQogICAgbGV0IG91dCA9IGBIVFRQLyR7MX0uJHsxfSAke3N0YXR1c0NvZGV9ICR7c3RhdHVzVGV4dH1cclxuYDsKICAgIGNvbnN0IGhlYWRlcnMgPSByMi5oZWFkZXJzID8/IG5ldyBIZWFkZXJzKCk7CiAgICBpZiAocjIuYm9keSAmJiAhaGVhZGVycy5nZXQoImNvbnRlbnQtbGVuZ3RoIikpIHsKICAgICAgICBpZiAocjIuYm9keSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgICAgICAgICAgb3V0ICs9IGBjb250ZW50LWxlbmd0aDogJHtyMi5ib2R5LmJ5dGVMZW5ndGh9XHJcbmA7CiAgICAgICAgfSBlbHNlIGlmICghaGVhZGVycy5nZXQoInRyYW5zZmVyLWVuY29kaW5nIikpIHsKICAgICAgICAgICAgb3V0ICs9ICJ0cmFuc2Zlci1lbmNvZGluZzogY2h1bmtlZFxyXG4iOwogICAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGhlYWRlcnMpewogICAgICAgIG91dCArPSBgJHtrZXl9OiAke3ZhbHVlfVxyXG5gOwogICAgfQogICAgb3V0ICs9IGBcclxuYDsKICAgIGNvbnN0IGhlYWRlciA9IGVuY29kZXIuZW5jb2RlKG91dCk7CiAgICBjb25zdCBuID0gYXdhaXQgd3JpdGVyMy53cml0ZShoZWFkZXIpOwogICAgYXNzZXJ0KG4gPT09IGhlYWRlci5ieXRlTGVuZ3RoKTsKICAgIGlmIChyMi5ib2R5IGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgIGNvbnN0IG4xID0gYXdhaXQgd3JpdGVyMy53cml0ZShyMi5ib2R5KTsKICAgICAgICBhc3NlcnQobjEgPT09IHIyLmJvZHkuYnl0ZUxlbmd0aCk7CiAgICB9IGVsc2UgaWYgKGhlYWRlcnMuaGFzKCJjb250ZW50LWxlbmd0aCIpKSB7CiAgICAgICAgY29uc3QgY29udGVudExlbmd0aCA9IGhlYWRlcnMuZ2V0KCJjb250ZW50LWxlbmd0aCIpOwogICAgICAgIGFzc2VydChjb250ZW50TGVuZ3RoICE9IG51bGwpOwogICAgICAgIGNvbnN0IGJvZHlMZW5ndGggPSBwYXJzZUludChjb250ZW50TGVuZ3RoKTsKICAgICAgICBjb25zdCBuMSA9IGF3YWl0IERlbm8uY29weShyMi5ib2R5LCB3cml0ZXIzKTsKICAgICAgICBhc3NlcnQobjEgPT09IGJvZHlMZW5ndGgpOwogICAgfSBlbHNlIHsKICAgICAgICBhd2FpdCB3cml0ZUNodW5rZWRCb2R5KHdyaXRlcjMsIHIyLmJvZHkpOwogICAgfQogICAgaWYgKHIyLnRyYWlsZXJzKSB7CiAgICAgICAgY29uc3QgdCA9IGF3YWl0IHIyLnRyYWlsZXJzKCk7CiAgICAgICAgYXdhaXQgd3JpdGVUcmFpbGVycyh3cml0ZXIzLCBoZWFkZXJzLCB0KTsKICAgIH0KICAgIGF3YWl0IHdyaXRlcjMuZmx1c2goKTsKfQpmdW5jdGlvbiBwYXJzZUhUVFBWZXJzaW9uKHZlcnMpIHsKICAgIHN3aXRjaCh2ZXJzKXsKICAgICAgICBjYXNlICJIVFRQLzEuMSI6CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgICAgMQogICAgICAgICAgICBdOwogICAgICAgIGNhc2UgIkhUVFAvMS4wIjoKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgIF07CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc3QgQmlnID0gMTAwMDAwMDsKICAgICAgICAgICAgICAgIGlmICghdmVycy5zdGFydHNXaXRoKCJIVFRQLyIpKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBkb3QgPSB2ZXJzLmluZGV4T2YoIi4iKTsKICAgICAgICAgICAgICAgIGlmIChkb3QgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBtYWpvclN0ciA9IHZlcnMuc3Vic3RyaW5nKHZlcnMuaW5kZXhPZigiLyIpICsgMSwgZG90KTsKICAgICAgICAgICAgICAgIGNvbnN0IG1ham9yID0gTnVtYmVyKG1ham9yU3RyKTsKICAgICAgICAgICAgICAgIGlmICghTnVtYmVyLmlzSW50ZWdlcihtYWpvcikgfHwgbWFqb3IgPCAwIHx8IG1ham9yID4gMTAwMDAwMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgbWlub3JTdHIgPSB2ZXJzLnN1YnN0cmluZyhkb3QgKyAxKTsKICAgICAgICAgICAgICAgIGNvbnN0IG1pbm9yID0gTnVtYmVyKG1pbm9yU3RyKTsKICAgICAgICAgICAgICAgIGlmICghTnVtYmVyLmlzSW50ZWdlcihtaW5vcikgfHwgbWlub3IgPCAwIHx8IG1pbm9yID4gMTAwMDAwMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgICAgICBtYWpvciwKICAgICAgICAgICAgICAgICAgICBtaW5vcgogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBtYWxmb3JtZWQgSFRUUCB2ZXJzaW9uICR7dmVyc31gKTsKfQpjbGFzcyBTZXJ2ZXJSZXF1ZXN0IHsKICAgICNkb25lPWRlZmVycmVkKCk7CiAgICAjY29udGVudExlbmd0aD11bmRlZmluZWQ7CiAgICAjYm9keT11bmRlZmluZWQ7CiAgICAjZmluYWxpemVkPWZhbHNlOwogICAgZ2V0IGRvbmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuI2RvbmUudGhlbigoZSk9PmUKICAgICAgICApOwogICAgfQogICAgZ2V0IGNvbnRlbnRMZW5ndGgoKSB7CiAgICAgICAgaWYgKHRoaXMuI2NvbnRlbnRMZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBjb25zdCBjbCA9IHRoaXMuaGVhZGVycy5nZXQoImNvbnRlbnQtbGVuZ3RoIik7CiAgICAgICAgICAgIGlmIChjbCkgewogICAgICAgICAgICAgICAgdGhpcy4jY29udGVudExlbmd0aCA9IHBhcnNlSW50KGNsKTsKICAgICAgICAgICAgICAgIGlmIChOdW1iZXIuaXNOYU4odGhpcy4jY29udGVudExlbmd0aCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLiNjb250ZW50TGVuZ3RoID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuI2NvbnRlbnRMZW5ndGggPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLiNjb250ZW50TGVuZ3RoOwogICAgfQogICAgZ2V0IGJvZHkoKSB7CiAgICAgICAgaWYgKCF0aGlzLiNib2R5KSB7CiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRlbnRMZW5ndGggIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy4jYm9keSA9IGJvZHlSZWFkZXIxKHRoaXMuY29udGVudExlbmd0aCwgdGhpcy5yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zZmVyRW5jb2RpbmcgPSB0aGlzLmhlYWRlcnMuZ2V0KCJ0cmFuc2Zlci1lbmNvZGluZyIpOwogICAgICAgICAgICAgICAgaWYgKHRyYW5zZmVyRW5jb2RpbmcgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gdHJhbnNmZXJFbmNvZGluZy5zcGxpdCgiLCIpLm1hcCgoZSk9PmUudHJpbSgpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIGFzc2VydChwYXJ0cy5pbmNsdWRlcygiY2h1bmtlZCIpLCAndHJhbnNmZXItZW5jb2RpbmcgbXVzdCBpbmNsdWRlICJjaHVua2VkIiBpZiBjb250ZW50LWxlbmd0aCBpcyBub3Qgc2V0Jyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4jYm9keSA9IGNodW5rZWRCb2R5UmVhZGVyMSh0aGlzLmhlYWRlcnMsIHRoaXMucik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuI2JvZHkgPSBlbXB0eVJlYWRlcjEoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy4jYm9keTsKICAgIH0KICAgIGFzeW5jIHJlc3BvbmQocikgewogICAgICAgIGxldCBlcnI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgd3JpdGVSZXNwb25zZSh0aGlzLncsIHIpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRoaXMuY29ubi5jbG9zZSgpOwogICAgICAgICAgICB9IGNhdGNoICB7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXJyID0gZTsKICAgICAgICB9CiAgICAgICAgdGhpcy4jZG9uZS5yZXNvbHZlKGVycik7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgZmluYWxpemUoKSB7CiAgICAgICAgaWYgKHRoaXMuI2ZpbmFsaXplZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IGJvZHkgPSB0aGlzLmJvZHk7CiAgICAgICAgY29uc3QgYnVmID0gbmV3IFVpbnQ4QXJyYXkoMTAyNCk7CiAgICAgICAgd2hpbGUoYXdhaXQgYm9keS5yZWFkKGJ1ZikgIT09IG51bGwpewogICAgICAgIH0KICAgICAgICB0aGlzLiNmaW5hbGl6ZWQgPSB0cnVlOwogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIHJlYWRSZXF1ZXN0KGNvbm4sIGJ1ZnIpIHsKICAgIGNvbnN0IHRwID0gbmV3IFRleHRQcm90b1JlYWRlcihidWZyKTsKICAgIGNvbnN0IGZpcnN0TGluZSA9IGF3YWl0IHRwLnJlYWRMaW5lKCk7CiAgICBpZiAoZmlyc3RMaW5lID09PSBudWxsKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGhlYWRlcnMgPSBhd2FpdCB0cC5yZWFkTUlNRUhlYWRlcigpOwogICAgaWYgKGhlYWRlcnMgPT09IG51bGwpIHRocm93IG5ldyBEZW5vLmVycm9ycy5VbmV4cGVjdGVkRW9mKCk7CiAgICBjb25zdCByZXEgPSBuZXcgU2VydmVyUmVxdWVzdCgpOwogICAgcmVxLmNvbm4gPSBjb25uOwogICAgcmVxLnIgPSBidWZyOwogICAgW3JlcS5tZXRob2QsIHJlcS51cmwsIHJlcS5wcm90b10gPSBmaXJzdExpbmUuc3BsaXQoIiAiLCAzKTsKICAgIFtyZXEucHJvdG9NYWpvciwgcmVxLnByb3RvTWlub3JdID0gcGFyc2VIVFRQVmVyc2lvbihyZXEucHJvdG8pOwogICAgcmVxLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgZml4TGVuZ3RoKHJlcSk7CiAgICByZXR1cm4gcmVxOwp9CmNvbnN0IHJlYWRSZXF1ZXN0MSA9IHJlYWRSZXF1ZXN0OwpmdW5jdGlvbiBmaXhMZW5ndGgocmVxKSB7CiAgICBjb25zdCBjb250ZW50TGVuZ3RoID0gcmVxLmhlYWRlcnMuZ2V0KCJDb250ZW50LUxlbmd0aCIpOwogICAgaWYgKGNvbnRlbnRMZW5ndGgpIHsKICAgICAgICBjb25zdCBhcnJDbGVuID0gY29udGVudExlbmd0aC5zcGxpdCgiLCIpOwogICAgICAgIGlmIChhcnJDbGVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgY29uc3QgZGlzdGluY3QgPSBbCiAgICAgICAgICAgICAgICAuLi5uZXcgU2V0KGFyckNsZW4ubWFwKChlKT0+ZS50cmltKCkKICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGlmIChkaXN0aW5jdC5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiY2Fubm90IGNvbnRhaW4gbXVsdGlwbGUgQ29udGVudC1MZW5ndGggaGVhZGVycyIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVxLmhlYWRlcnMuc2V0KCJDb250ZW50LUxlbmd0aCIsIGRpc3RpbmN0WzBdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBjID0gcmVxLmhlYWRlcnMuZ2V0KCJDb250ZW50LUxlbmd0aCIpOwogICAgICAgIGlmIChyZXEubWV0aG9kID09PSAiSEVBRCIgJiYgYyAmJiBjICE9PSAiMCIpIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoImh0dHA6IG1ldGhvZCBjYW5ub3QgY29udGFpbiBhIENvbnRlbnQtTGVuZ3RoIik7CiAgICAgICAgfQogICAgICAgIGlmIChjICYmIHJlcS5oZWFkZXJzLmhhcygidHJhbnNmZXItZW5jb2RpbmciKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImh0dHA6IFRyYW5zZmVyLUVuY29kaW5nIGFuZCBDb250ZW50LUxlbmd0aCBjYW5ub3QgYmUgc2VuZCB0b2dldGhlciIpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBTZXJ2ZXIgewogICAgI2Nsb3Npbmc9ZmFsc2U7CiAgICAjY29ubmVjdGlvbnM9W107CiAgICBjb25zdHJ1Y3RvcihsaXN0ZW5lcil7CiAgICAgICAgdGhpcy5saXN0ZW5lciA9IGxpc3RlbmVyOwogICAgfQogICAgY2xvc2UoKSB7CiAgICAgICAgdGhpcy4jY2xvc2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5saXN0ZW5lci5jbG9zZSgpOwogICAgICAgIGZvciAoY29uc3QgY29ubiBvZiB0aGlzLiNjb25uZWN0aW9ucyl7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb25uLmNsb3NlKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGlmICghKGUgaW5zdGFuY2VvZiBEZW5vLmVycm9ycy5CYWRSZXNvdXJjZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgKml0ZXJhdGVIdHRwUmVxdWVzdHMoY29ubikgewogICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBCdWZSZWFkZXIoY29ubik7CiAgICAgICAgY29uc3Qgd3JpdGVyMyA9IG5ldyBCdWZXcml0ZXIoY29ubik7CiAgICAgICAgd2hpbGUoIXRoaXMuI2Nsb3NpbmcpewogICAgICAgICAgICBsZXQgcmVxdWVzdDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlcXVlc3QgPSBhd2FpdCByZWFkUmVxdWVzdDEoY29ubiwgcmVhZGVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLkludmFsaWREYXRhIHx8IGVycm9yIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuVW5leHBlY3RlZEVvZikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHdyaXRlUmVzcG9uc2Uod3JpdGVyMywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiA0MDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5OiBlbmNvZGUoYCR7ZXJyb3IubWVzc2FnZX1cclxuXHJcbmApCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlcXVlc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlcXVlc3QudyA9IHdyaXRlcjM7CiAgICAgICAgICAgIHlpZWxkIHJlcXVlc3Q7CiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlRXJyb3IgPSBhd2FpdCByZXF1ZXN0LmRvbmU7CiAgICAgICAgICAgIGlmIChyZXNwb25zZUVycm9yKSB7CiAgICAgICAgICAgICAgICB0aGlzLnVudHJhY2tDb25uZWN0aW9uKHJlcXVlc3QuY29ubik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGF3YWl0IHJlcXVlc3QuZmluYWxpemUoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMudW50cmFja0Nvbm5lY3Rpb24oY29ubik7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29ubi5jbG9zZSgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICB9CiAgICB0cmFja0Nvbm5lY3Rpb24oY29ubikgewogICAgICAgIHRoaXMuI2Nvbm5lY3Rpb25zLnB1c2goY29ubik7CiAgICB9CiAgICB1bnRyYWNrQ29ubmVjdGlvbihjb25uKSB7CiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLiNjb25uZWN0aW9ucy5pbmRleE9mKGNvbm4pOwogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgdGhpcy4jY29ubmVjdGlvbnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyAqYWNjZXB0Q29ubkFuZEl0ZXJhdGVIdHRwUmVxdWVzdHMobXV4KSB7CiAgICAgICAgaWYgKHRoaXMuI2Nsb3NpbmcpIHJldHVybjsKICAgICAgICBsZXQgY29ubjsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25uID0gYXdhaXQgdGhpcy5saXN0ZW5lci5hY2NlcHQoKTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBEZW5vLmVycm9ycy5CYWRSZXNvdXJjZSB8fCBlcnJvciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLkludmFsaWREYXRhIHx8IGVycm9yIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuVW5leHBlY3RlZEVvZiB8fCBlcnJvciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLkNvbm5lY3Rpb25SZXNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG11eC5hZGQodGhpcy5hY2NlcHRDb25uQW5kSXRlcmF0ZUh0dHBSZXF1ZXN0cyhtdXgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICAgICAgdGhpcy50cmFja0Nvbm5lY3Rpb24oY29ubik7CiAgICAgICAgbXV4LmFkZCh0aGlzLmFjY2VwdENvbm5BbmRJdGVyYXRlSHR0cFJlcXVlc3RzKG11eCkpOwogICAgICAgIHlpZWxkKiB0aGlzLml0ZXJhdGVIdHRwUmVxdWVzdHMoY29ubik7CiAgICB9CiAgICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkgewogICAgICAgIGNvbnN0IG11eCA9IG5ldyBNdXhBc3luY0l0ZXJhdG9yKCk7CiAgICAgICAgbXV4LmFkZCh0aGlzLmFjY2VwdENvbm5BbmRJdGVyYXRlSHR0cFJlcXVlc3RzKG11eCkpOwogICAgICAgIHJldHVybiBtdXguaXRlcmF0ZSgpOwogICAgfQp9CmZ1bmN0aW9uIF9wYXJzZUFkZHJGcm9tU3RyKGFkZHIpIHsKICAgIGxldCB1cmw7CiAgICB0cnkgewogICAgICAgIGNvbnN0IGhvc3QgPSBhZGRyLnN0YXJ0c1dpdGgoIjoiKSA/IGAwLjAuMC4wJHthZGRyfWAgOiBhZGRyOwogICAgICAgIHVybCA9IG5ldyBVUkwoYGh0dHA6Ly8ke2hvc3R9YCk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhZGRyZXNzLiIpOwogICAgfQogICAgaWYgKHVybC51c2VybmFtZSB8fCB1cmwucGFzc3dvcmQgfHwgdXJsLnBhdGhuYW1lICE9ICIvIiB8fCB1cmwuc2VhcmNoIHx8IHVybC5oYXNoKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiSW52YWxpZCBhZGRyZXNzLiIpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBob3N0bmFtZTogdXJsLmhvc3RuYW1lLAogICAgICAgIHBvcnQ6IHVybC5wb3J0ID09PSAiIiA/IDgwIDogTnVtYmVyKHVybC5wb3J0KQogICAgfTsKfQpmdW5jdGlvbiBzZXJ2ZShhZGRyKSB7CiAgICBpZiAodHlwZW9mIGFkZHIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgYWRkciA9IF9wYXJzZUFkZHJGcm9tU3RyKGFkZHIpOwogICAgfQogICAgY29uc3QgbGlzdGVuZXIxID0gRGVuby5saXN0ZW4oYWRkcik7CiAgICByZXR1cm4gbmV3IFNlcnZlcihsaXN0ZW5lcjEpOwp9CmZ1bmN0aW9uIHNlcnZlVExTKG9wdGlvbnMpIHsKICAgIGNvbnN0IHRsc09wdGlvbnMgPSB7CiAgICAgICAgLi4ub3B0aW9ucywKICAgICAgICB0cmFuc3BvcnQ6ICJ0Y3AiCiAgICB9OwogICAgY29uc3QgbGlzdGVuZXIxID0gRGVuby5saXN0ZW5UbHModGxzT3B0aW9ucyk7CiAgICByZXR1cm4gbmV3IFNlcnZlcihsaXN0ZW5lcjEpOwp9CmZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgdikgewogICAgaWYgKG9iaiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHYpOwp9CmNvbnN0IERFRkFVTFRfQlVGRkVSX1NJWkUgPSAzMiAqIDEwMjQ7CmFzeW5jIGZ1bmN0aW9uIHJlYWRTaG9ydChidWYpIHsKICAgIGNvbnN0IGhpZ2ggPSBhd2FpdCBidWYucmVhZEJ5dGUoKTsKICAgIGlmIChoaWdoID09PSBudWxsKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGxvdyA9IGF3YWl0IGJ1Zi5yZWFkQnl0ZSgpOwogICAgaWYgKGxvdyA9PT0gbnVsbCkgdGhyb3cgbmV3IERlbm8uZXJyb3JzLlVuZXhwZWN0ZWRFb2YoKTsKICAgIHJldHVybiBoaWdoIDw8IDggfCBsb3c7Cn0KYXN5bmMgZnVuY3Rpb24gcmVhZEludChidWYpIHsKICAgIGNvbnN0IGhpZ2ggPSBhd2FpdCByZWFkU2hvcnQoYnVmKTsKICAgIGlmIChoaWdoID09PSBudWxsKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGxvdyA9IGF3YWl0IHJlYWRTaG9ydChidWYpOwogICAgaWYgKGxvdyA9PT0gbnVsbCkgdGhyb3cgbmV3IERlbm8uZXJyb3JzLlVuZXhwZWN0ZWRFb2YoKTsKICAgIHJldHVybiBoaWdoIDw8IDE2IHwgbG93Owp9CmNvbnN0IE1BWF9TQUZFX0lOVEVHRVIgPSBCaWdJbnQoTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpOwphc3luYyBmdW5jdGlvbiByZWFkTG9uZyhidWYpIHsKICAgIGNvbnN0IGhpZ2ggPSBhd2FpdCByZWFkSW50KGJ1Zik7CiAgICBpZiAoaGlnaCA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICBjb25zdCBsb3cgPSBhd2FpdCByZWFkSW50KGJ1Zik7CiAgICBpZiAobG93ID09PSBudWxsKSB0aHJvdyBuZXcgRGVuby5lcnJvcnMuVW5leHBlY3RlZEVvZigpOwogICAgY29uc3QgYmlnID0gQmlnSW50KGhpZ2gpIDw8IDMybiB8IEJpZ0ludChsb3cpOwogICAgaWYgKGJpZyA+IE1BWF9TQUZFX0lOVEVHRVIpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigiTG9uZyB2YWx1ZSB0b28gYmlnIHRvIGJlIHJlcHJlc2VudGVkIGFzIGEgSmF2YVNjcmlwdCBudW1iZXIuIik7CiAgICB9CiAgICByZXR1cm4gTnVtYmVyKGJpZyk7Cn0KZnVuY3Rpb24gc2xpY2VMb25nVG9CeXRlcyhkLCBkZXN0ID0gbmV3IEFycmF5KDgpKSB7CiAgICBsZXQgYmlnID0gQmlnSW50KGQpOwogICAgZm9yKGxldCBpID0gMDsgaSA8IDg7IGkrKyl7CiAgICAgICAgZGVzdFs3IC0gaV0gPSBOdW1iZXIoYmlnICYgMjU1bik7CiAgICAgICAgYmlnID4+PSA4bjsKICAgIH0KICAgIHJldHVybiBkZXN0Owp9CmNvbnN0IHNsaWNlTG9uZ1RvQnl0ZXMxID0gc2xpY2VMb25nVG9CeXRlczsKY29uc3QgSEVYX0NIQVJTID0gIjAxMjM0NTY3ODlhYmNkZWYiLnNwbGl0KCIiKTsKY29uc3QgRVhUUkEgPSBbCiAgICAtMjE0NzQ4MzY0OCwKICAgIDgzODg2MDgsCiAgICAzMjc2OCwKICAgIDEyOApdOwpjb25zdCBTSElGVCA9IFsKICAgIDI0LAogICAgMTYsCiAgICA4LAogICAgMApdOwpjb25zdCBibG9ja3MgPSBbXTsKY2xhc3MgU2hhMSB7CiAgICAjYmxvY2tzOwogICAgI2Jsb2NrOwogICAgI3N0YXJ0OwogICAgI2J5dGVzOwogICAgI2hCeXRlczsKICAgICNmaW5hbGl6ZWQ7CiAgICAjaGFzaGVkOwogICAgI2gwPTE3MzI1ODQxOTM7CiAgICAjaDE9NDAyMzIzMzQxNzsKICAgICNoMj0yNTYyMzgzMTAyOwogICAgI2gzPTI3MTczMzg3ODsKICAgICNoND0zMjg1Mzc3NTIwOwogICAgI2xhc3RCeXRlSW5kZXg9MDsKICAgIGNvbnN0cnVjdG9yKHNoYXJlZE1lbW9yeTEgPSBmYWxzZSl7CiAgICAgICAgdGhpcy5pbml0KHNoYXJlZE1lbW9yeTEpOwogICAgfQogICAgaW5pdChzaGFyZWRNZW1vcnkpIHsKICAgICAgICBpZiAoc2hhcmVkTWVtb3J5KSB7CiAgICAgICAgICAgIGJsb2Nrc1swXSA9IGJsb2Nrc1sxNl0gPSBibG9ja3NbMV0gPSBibG9ja3NbMl0gPSBibG9ja3NbM10gPSBibG9ja3NbNF0gPSBibG9ja3NbNV0gPSBibG9ja3NbNl0gPSBibG9ja3NbN10gPSBibG9ja3NbOF0gPSBibG9ja3NbOV0gPSBibG9ja3NbMTBdID0gYmxvY2tzWzExXSA9IGJsb2Nrc1sxMl0gPSBibG9ja3NbMTNdID0gYmxvY2tzWzE0XSA9IGJsb2Nrc1sxNV0gPSAwOwogICAgICAgICAgICB0aGlzLiNibG9ja3MgPSBibG9ja3M7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy4jYmxvY2tzID0gWwogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy4jaDAgPSAxNzMyNTg0MTkzOwogICAgICAgIHRoaXMuI2gxID0gNDAyMzIzMzQxNzsKICAgICAgICB0aGlzLiNoMiA9IDI1NjIzODMxMDI7CiAgICAgICAgdGhpcy4jaDMgPSAyNzE3MzM4Nzg7CiAgICAgICAgdGhpcy4jaDQgPSAzMjg1Mzc3NTIwOwogICAgICAgIHRoaXMuI2Jsb2NrID0gdGhpcy4jc3RhcnQgPSB0aGlzLiNieXRlcyA9IHRoaXMuI2hCeXRlcyA9IDA7CiAgICAgICAgdGhpcy4jZmluYWxpemVkID0gdGhpcy4jaGFzaGVkID0gZmFsc2U7CiAgICB9CiAgICB1cGRhdGUobWVzc2FnZSkgewogICAgICAgIGlmICh0aGlzLiNmaW5hbGl6ZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIGxldCBtc2c7CiAgICAgICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICAgICAgICBtc2cgPSBuZXcgVWludDhBcnJheShtZXNzYWdlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtc2cgPSBtZXNzYWdlOwogICAgICAgIH0KICAgICAgICBsZXQgaW5kZXggPSAwOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IG1zZy5sZW5ndGg7CiAgICAgICAgY29uc3QgYmxvY2tzMSA9IHRoaXMuI2Jsb2NrczsKICAgICAgICB3aGlsZShpbmRleCA8IGxlbmd0aCl7CiAgICAgICAgICAgIGxldCBpOwogICAgICAgICAgICBpZiAodGhpcy4jaGFzaGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLiNoYXNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGJsb2NrczFbMF0gPSB0aGlzLiNibG9jazsKICAgICAgICAgICAgICAgIGJsb2NrczFbMTZdID0gYmxvY2tzMVsxXSA9IGJsb2NrczFbMl0gPSBibG9ja3MxWzNdID0gYmxvY2tzMVs0XSA9IGJsb2NrczFbNV0gPSBibG9ja3MxWzZdID0gYmxvY2tzMVs3XSA9IGJsb2NrczFbOF0gPSBibG9ja3MxWzldID0gYmxvY2tzMVsxMF0gPSBibG9ja3MxWzExXSA9IGJsb2NrczFbMTJdID0gYmxvY2tzMVsxM10gPSBibG9ja3MxWzE0XSA9IGJsb2NrczFbMTVdID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG1zZyAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGZvcihpID0gdGhpcy4jc3RhcnQ7IGluZGV4IDwgbGVuZ3RoICYmIGkgPCA2NDsgKytpbmRleCl7CiAgICAgICAgICAgICAgICAgICAgYmxvY2tzMVtpID4+IDJdIHw9IG1zZ1tpbmRleF0gPDwgU0hJRlRbKGkrKykgJiAzXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvcihpID0gdGhpcy4jc3RhcnQ7IGluZGV4IDwgbGVuZ3RoICYmIGkgPCA2NDsgKytpbmRleCl7CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvZGUgPSBtc2cuY2hhckNvZGVBdChpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvZGUgPCAxMjgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tzMVtpID4+IDJdIHw9IGNvZGUgPDwgU0hJRlRbKGkrKykgJiAzXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvZGUgPCAyMDQ4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrczFbaSA+PiAyXSB8PSAoMTkyIHwgY29kZSA+PiA2KSA8PCBTSElGVFsoaSsrKSAmIDNdOwogICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MxW2kgPj4gMl0gfD0gKDEyOCB8IGNvZGUgJiA2MykgPDwgU0hJRlRbKGkrKykgJiAzXTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvZGUgPCA1NTI5NiB8fCBjb2RlID49IDU3MzQ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrczFbaSA+PiAyXSB8PSAoMjI0IHwgY29kZSA+PiAxMikgPDwgU0hJRlRbKGkrKykgJiAzXTsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tzMVtpID4+IDJdIHw9ICgxMjggfCBjb2RlID4+IDYgJiA2MykgPDwgU0hJRlRbKGkrKykgJiAzXTsKICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tzMVtpID4+IDJdIHw9ICgxMjggfCBjb2RlICYgNjMpIDw8IFNISUZUWyhpKyspICYgM107CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IDY1NTM2ICsgKChjb2RlICYgMTAyMykgPDwgMTAgfCBtc2cuY2hhckNvZGVBdCgrK2luZGV4KSAmIDEwMjMpOwogICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MxW2kgPj4gMl0gfD0gKDI0MCB8IGNvZGUgPj4gMTgpIDw8IFNISUZUWyhpKyspICYgM107CiAgICAgICAgICAgICAgICAgICAgICAgIGJsb2NrczFbaSA+PiAyXSB8PSAoMTI4IHwgY29kZSA+PiAxMiAmIDYzKSA8PCBTSElGVFsoaSsrKSAmIDNdOwogICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MxW2kgPj4gMl0gfD0gKDEyOCB8IGNvZGUgPj4gNiAmIDYzKSA8PCBTSElGVFsoaSsrKSAmIDNdOwogICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MxW2kgPj4gMl0gfD0gKDEyOCB8IGNvZGUgJiA2MykgPDwgU0hJRlRbKGkrKykgJiAzXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy4jbGFzdEJ5dGVJbmRleCA9IGk7CiAgICAgICAgICAgIHRoaXMuI2J5dGVzICs9IGkgLSB0aGlzLiNzdGFydDsKICAgICAgICAgICAgaWYgKGkgPj0gNjQpIHsKICAgICAgICAgICAgICAgIHRoaXMuI2Jsb2NrID0gYmxvY2tzMVsxNl07CiAgICAgICAgICAgICAgICB0aGlzLiNzdGFydCA9IGkgLSA2NDsKICAgICAgICAgICAgICAgIHRoaXMuaGFzaCgpOwogICAgICAgICAgICAgICAgdGhpcy4jaGFzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuI3N0YXJ0ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy4jYnl0ZXMgPiA0Mjk0OTY3Mjk1KSB7CiAgICAgICAgICAgIHRoaXMuI2hCeXRlcyArPSB0aGlzLiNieXRlcyAvIDQyOTQ5NjcyOTYgPj4+IDA7CiAgICAgICAgICAgIHRoaXMuI2J5dGVzID0gdGhpcy4jYnl0ZXMgPj4+IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgZmluYWxpemUoKSB7CiAgICAgICAgaWYgKHRoaXMuI2ZpbmFsaXplZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuI2ZpbmFsaXplZCA9IHRydWU7CiAgICAgICAgY29uc3QgYmxvY2tzMSA9IHRoaXMuI2Jsb2NrczsKICAgICAgICBjb25zdCBpID0gdGhpcy4jbGFzdEJ5dGVJbmRleDsKICAgICAgICBibG9ja3MxWzE2XSA9IHRoaXMuI2Jsb2NrOwogICAgICAgIGJsb2NrczFbaSA+PiAyXSB8PSBFWFRSQVtpICYgM107CiAgICAgICAgdGhpcy4jYmxvY2sgPSBibG9ja3MxWzE2XTsKICAgICAgICBpZiAoaSA+PSA1NikgewogICAgICAgICAgICBpZiAoIXRoaXMuI2hhc2hlZCkgewogICAgICAgICAgICAgICAgdGhpcy5oYXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYmxvY2tzMVswXSA9IHRoaXMuI2Jsb2NrOwogICAgICAgICAgICBibG9ja3MxWzE2XSA9IGJsb2NrczFbMV0gPSBibG9ja3MxWzJdID0gYmxvY2tzMVszXSA9IGJsb2NrczFbNF0gPSBibG9ja3MxWzVdID0gYmxvY2tzMVs2XSA9IGJsb2NrczFbN10gPSBibG9ja3MxWzhdID0gYmxvY2tzMVs5XSA9IGJsb2NrczFbMTBdID0gYmxvY2tzMVsxMV0gPSBibG9ja3MxWzEyXSA9IGJsb2NrczFbMTNdID0gYmxvY2tzMVsxNF0gPSBibG9ja3MxWzE1XSA9IDA7CiAgICAgICAgfQogICAgICAgIGJsb2NrczFbMTRdID0gdGhpcy4jaEJ5dGVzIDw8IDMgfCB0aGlzLiNieXRlcyA+Pj4gMjk7CiAgICAgICAgYmxvY2tzMVsxNV0gPSB0aGlzLiNieXRlcyA8PCAzOwogICAgICAgIHRoaXMuaGFzaCgpOwogICAgfQogICAgaGFzaCgpIHsKICAgICAgICBsZXQgYSA9IHRoaXMuI2gwOwogICAgICAgIGxldCBiID0gdGhpcy4jaDE7CiAgICAgICAgbGV0IGMgPSB0aGlzLiNoMjsKICAgICAgICBsZXQgZCA9IHRoaXMuI2gzOwogICAgICAgIGxldCBlID0gdGhpcy4jaDQ7CiAgICAgICAgbGV0IGY7CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IHQ7CiAgICAgICAgY29uc3QgYmxvY2tzMSA9IHRoaXMuI2Jsb2NrczsKICAgICAgICBmb3IoaiA9IDE2OyBqIDwgODA7ICsrail7CiAgICAgICAgICAgIHQgPSBibG9ja3MxW2ogLSAzXSBeIGJsb2NrczFbaiAtIDhdIF4gYmxvY2tzMVtqIC0gMTRdIF4gYmxvY2tzMVtqIC0gMTZdOwogICAgICAgICAgICBibG9ja3MxW2pdID0gdCA8PCAxIHwgdCA+Pj4gMzE7CiAgICAgICAgfQogICAgICAgIGZvcihqID0gMDsgaiA8IDIwOyBqICs9IDUpewogICAgICAgICAgICBmID0gYiAmIGMgfCB+YiAmIGQ7CiAgICAgICAgICAgIHQgPSBhIDw8IDUgfCBhID4+PiAyNzsKICAgICAgICAgICAgZSA9IHQgKyBmICsgZSArIDE1MTg1MDAyNDkgKyBibG9ja3MxW2pdID4+PiAwOwogICAgICAgICAgICBiID0gYiA8PCAzMCB8IGIgPj4+IDI7CiAgICAgICAgICAgIGYgPSBhICYgYiB8IH5hICYgYzsKICAgICAgICAgICAgdCA9IGUgPDwgNSB8IGUgPj4+IDI3OwogICAgICAgICAgICBkID0gdCArIGYgKyBkICsgMTUxODUwMDI0OSArIGJsb2NrczFbaiArIDFdID4+PiAwOwogICAgICAgICAgICBhID0gYSA8PCAzMCB8IGEgPj4+IDI7CiAgICAgICAgICAgIGYgPSBlICYgYSB8IH5lICYgYjsKICAgICAgICAgICAgdCA9IGQgPDwgNSB8IGQgPj4+IDI3OwogICAgICAgICAgICBjID0gdCArIGYgKyBjICsgMTUxODUwMDI0OSArIGJsb2NrczFbaiArIDJdID4+PiAwOwogICAgICAgICAgICBlID0gZSA8PCAzMCB8IGUgPj4+IDI7CiAgICAgICAgICAgIGYgPSBkICYgZSB8IH5kICYgYTsKICAgICAgICAgICAgdCA9IGMgPDwgNSB8IGMgPj4+IDI3OwogICAgICAgICAgICBiID0gdCArIGYgKyBiICsgMTUxODUwMDI0OSArIGJsb2NrczFbaiArIDNdID4+PiAwOwogICAgICAgICAgICBkID0gZCA8PCAzMCB8IGQgPj4+IDI7CiAgICAgICAgICAgIGYgPSBjICYgZCB8IH5jICYgZTsKICAgICAgICAgICAgdCA9IGIgPDwgNSB8IGIgPj4+IDI3OwogICAgICAgICAgICBhID0gdCArIGYgKyBhICsgMTUxODUwMDI0OSArIGJsb2NrczFbaiArIDRdID4+PiAwOwogICAgICAgICAgICBjID0gYyA8PCAzMCB8IGMgPj4+IDI7CiAgICAgICAgfQogICAgICAgIGZvcig7IGogPCA0MDsgaiArPSA1KXsKICAgICAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICAgICAgdCA9IGEgPDwgNSB8IGEgPj4+IDI3OwogICAgICAgICAgICBlID0gdCArIGYgKyBlICsgMTg1OTc3NTM5MyArIGJsb2NrczFbal0gPj4+IDA7CiAgICAgICAgICAgIGIgPSBiIDw8IDMwIHwgYiA+Pj4gMjsKICAgICAgICAgICAgZiA9IGEgXiBiIF4gYzsKICAgICAgICAgICAgdCA9IGUgPDwgNSB8IGUgPj4+IDI3OwogICAgICAgICAgICBkID0gdCArIGYgKyBkICsgMTg1OTc3NTM5MyArIGJsb2NrczFbaiArIDFdID4+PiAwOwogICAgICAgICAgICBhID0gYSA8PCAzMCB8IGEgPj4+IDI7CiAgICAgICAgICAgIGYgPSBlIF4gYSBeIGI7CiAgICAgICAgICAgIHQgPSBkIDw8IDUgfCBkID4+PiAyNzsKICAgICAgICAgICAgYyA9IHQgKyBmICsgYyArIDE4NTk3NzUzOTMgKyBibG9ja3MxW2ogKyAyXSA+Pj4gMDsKICAgICAgICAgICAgZSA9IGUgPDwgMzAgfCBlID4+PiAyOwogICAgICAgICAgICBmID0gZCBeIGUgXiBhOwogICAgICAgICAgICB0ID0gYyA8PCA1IHwgYyA+Pj4gMjc7CiAgICAgICAgICAgIGIgPSB0ICsgZiArIGIgKyAxODU5Nzc1MzkzICsgYmxvY2tzMVtqICsgM10gPj4+IDA7CiAgICAgICAgICAgIGQgPSBkIDw8IDMwIHwgZCA+Pj4gMjsKICAgICAgICAgICAgZiA9IGMgXiBkIF4gZTsKICAgICAgICAgICAgdCA9IGIgPDwgNSB8IGIgPj4+IDI3OwogICAgICAgICAgICBhID0gdCArIGYgKyBhICsgMTg1OTc3NTM5MyArIGJsb2NrczFbaiArIDRdID4+PiAwOwogICAgICAgICAgICBjID0gYyA8PCAzMCB8IGMgPj4+IDI7CiAgICAgICAgfQogICAgICAgIGZvcig7IGogPCA2MDsgaiArPSA1KXsKICAgICAgICAgICAgZiA9IGIgJiBjIHwgYiAmIGQgfCBjICYgZDsKICAgICAgICAgICAgdCA9IGEgPDwgNSB8IGEgPj4+IDI3OwogICAgICAgICAgICBlID0gdCArIGYgKyBlIC0gMTg5NDAwNzU4OCArIGJsb2NrczFbal0gPj4+IDA7CiAgICAgICAgICAgIGIgPSBiIDw8IDMwIHwgYiA+Pj4gMjsKICAgICAgICAgICAgZiA9IGEgJiBiIHwgYSAmIGMgfCBiICYgYzsKICAgICAgICAgICAgdCA9IGUgPDwgNSB8IGUgPj4+IDI3OwogICAgICAgICAgICBkID0gdCArIGYgKyBkIC0gMTg5NDAwNzU4OCArIGJsb2NrczFbaiArIDFdID4+PiAwOwogICAgICAgICAgICBhID0gYSA8PCAzMCB8IGEgPj4+IDI7CiAgICAgICAgICAgIGYgPSBlICYgYSB8IGUgJiBiIHwgYSAmIGI7CiAgICAgICAgICAgIHQgPSBkIDw8IDUgfCBkID4+PiAyNzsKICAgICAgICAgICAgYyA9IHQgKyBmICsgYyAtIDE4OTQwMDc1ODggKyBibG9ja3MxW2ogKyAyXSA+Pj4gMDsKICAgICAgICAgICAgZSA9IGUgPDwgMzAgfCBlID4+PiAyOwogICAgICAgICAgICBmID0gZCAmIGUgfCBkICYgYSB8IGUgJiBhOwogICAgICAgICAgICB0ID0gYyA8PCA1IHwgYyA+Pj4gMjc7CiAgICAgICAgICAgIGIgPSB0ICsgZiArIGIgLSAxODk0MDA3NTg4ICsgYmxvY2tzMVtqICsgM10gPj4+IDA7CiAgICAgICAgICAgIGQgPSBkIDw8IDMwIHwgZCA+Pj4gMjsKICAgICAgICAgICAgZiA9IGMgJiBkIHwgYyAmIGUgfCBkICYgZTsKICAgICAgICAgICAgdCA9IGIgPDwgNSB8IGIgPj4+IDI3OwogICAgICAgICAgICBhID0gdCArIGYgKyBhIC0gMTg5NDAwNzU4OCArIGJsb2NrczFbaiArIDRdID4+PiAwOwogICAgICAgICAgICBjID0gYyA8PCAzMCB8IGMgPj4+IDI7CiAgICAgICAgfQogICAgICAgIGZvcig7IGogPCA4MDsgaiArPSA1KXsKICAgICAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICAgICAgdCA9IGEgPDwgNSB8IGEgPj4+IDI3OwogICAgICAgICAgICBlID0gdCArIGYgKyBlIC0gODk5NDk3NTE0ICsgYmxvY2tzMVtqXSA+Pj4gMDsKICAgICAgICAgICAgYiA9IGIgPDwgMzAgfCBiID4+PiAyOwogICAgICAgICAgICBmID0gYSBeIGIgXiBjOwogICAgICAgICAgICB0ID0gZSA8PCA1IHwgZSA+Pj4gMjc7CiAgICAgICAgICAgIGQgPSB0ICsgZiArIGQgLSA4OTk0OTc1MTQgKyBibG9ja3MxW2ogKyAxXSA+Pj4gMDsKICAgICAgICAgICAgYSA9IGEgPDwgMzAgfCBhID4+PiAyOwogICAgICAgICAgICBmID0gZSBeIGEgXiBiOwogICAgICAgICAgICB0ID0gZCA8PCA1IHwgZCA+Pj4gMjc7CiAgICAgICAgICAgIGMgPSB0ICsgZiArIGMgLSA4OTk0OTc1MTQgKyBibG9ja3MxW2ogKyAyXSA+Pj4gMDsKICAgICAgICAgICAgZSA9IGUgPDwgMzAgfCBlID4+PiAyOwogICAgICAgICAgICBmID0gZCBeIGUgXiBhOwogICAgICAgICAgICB0ID0gYyA8PCA1IHwgYyA+Pj4gMjc7CiAgICAgICAgICAgIGIgPSB0ICsgZiArIGIgLSA4OTk0OTc1MTQgKyBibG9ja3MxW2ogKyAzXSA+Pj4gMDsKICAgICAgICAgICAgZCA9IGQgPDwgMzAgfCBkID4+PiAyOwogICAgICAgICAgICBmID0gYyBeIGQgXiBlOwogICAgICAgICAgICB0ID0gYiA8PCA1IHwgYiA+Pj4gMjc7CiAgICAgICAgICAgIGEgPSB0ICsgZiArIGEgLSA4OTk0OTc1MTQgKyBibG9ja3MxW2ogKyA0XSA+Pj4gMDsKICAgICAgICAgICAgYyA9IGMgPDwgMzAgfCBjID4+PiAyOwogICAgICAgIH0KICAgICAgICB0aGlzLiNoMCA9IHRoaXMuI2gwICsgYSA+Pj4gMDsKICAgICAgICB0aGlzLiNoMSA9IHRoaXMuI2gxICsgYiA+Pj4gMDsKICAgICAgICB0aGlzLiNoMiA9IHRoaXMuI2gyICsgYyA+Pj4gMDsKICAgICAgICB0aGlzLiNoMyA9IHRoaXMuI2gzICsgZCA+Pj4gMDsKICAgICAgICB0aGlzLiNoNCA9IHRoaXMuI2g0ICsgZSA+Pj4gMDsKICAgIH0KICAgIGhleCgpIHsKICAgICAgICB0aGlzLmZpbmFsaXplKCk7CiAgICAgICAgY29uc3QgaDAgPSB0aGlzLiNoMDsKICAgICAgICBjb25zdCBoMSA9IHRoaXMuI2gxOwogICAgICAgIGNvbnN0IGgyID0gdGhpcy4jaDI7CiAgICAgICAgY29uc3QgaDMgPSB0aGlzLiNoMzsKICAgICAgICBjb25zdCBoNCA9IHRoaXMuI2g0OwogICAgICAgIHJldHVybiBIRVhfQ0hBUlNbaDAgPj4gMjggJiAxNV0gKyBIRVhfQ0hBUlNbaDAgPj4gMjQgJiAxNV0gKyBIRVhfQ0hBUlNbaDAgPj4gMjAgJiAxNV0gKyBIRVhfQ0hBUlNbaDAgPj4gMTYgJiAxNV0gKyBIRVhfQ0hBUlNbaDAgPj4gMTIgJiAxNV0gKyBIRVhfQ0hBUlNbaDAgPj4gOCAmIDE1XSArIEhFWF9DSEFSU1toMCA+PiA0ICYgMTVdICsgSEVYX0NIQVJTW2gwICYgMTVdICsgSEVYX0NIQVJTW2gxID4+IDI4ICYgMTVdICsgSEVYX0NIQVJTW2gxID4+IDI0ICYgMTVdICsgSEVYX0NIQVJTW2gxID4+IDIwICYgMTVdICsgSEVYX0NIQVJTW2gxID4+IDE2ICYgMTVdICsgSEVYX0NIQVJTW2gxID4+IDEyICYgMTVdICsgSEVYX0NIQVJTW2gxID4+IDggJiAxNV0gKyBIRVhfQ0hBUlNbaDEgPj4gNCAmIDE1XSArIEhFWF9DSEFSU1toMSAmIDE1XSArIEhFWF9DSEFSU1toMiA+PiAyOCAmIDE1XSArIEhFWF9DSEFSU1toMiA+PiAyNCAmIDE1XSArIEhFWF9DSEFSU1toMiA+PiAyMCAmIDE1XSArIEhFWF9DSEFSU1toMiA+PiAxNiAmIDE1XSArIEhFWF9DSEFSU1toMiA+PiAxMiAmIDE1XSArIEhFWF9DSEFSU1toMiA+PiA4ICYgMTVdICsgSEVYX0NIQVJTW2gyID4+IDQgJiAxNV0gKyBIRVhfQ0hBUlNbaDIgJiAxNV0gKyBIRVhfQ0hBUlNbaDMgPj4gMjggJiAxNV0gKyBIRVhfQ0hBUlNbaDMgPj4gMjQgJiAxNV0gKyBIRVhfQ0hBUlNbaDMgPj4gMjAgJiAxNV0gKyBIRVhfQ0hBUlNbaDMgPj4gMTYgJiAxNV0gKyBIRVhfQ0hBUlNbaDMgPj4gMTIgJiAxNV0gKyBIRVhfQ0hBUlNbaDMgPj4gOCAmIDE1XSArIEhFWF9DSEFSU1toMyA+PiA0ICYgMTVdICsgSEVYX0NIQVJTW2gzICYgMTVdICsgSEVYX0NIQVJTW2g0ID4+IDI4ICYgMTVdICsgSEVYX0NIQVJTW2g0ID4+IDI0ICYgMTVdICsgSEVYX0NIQVJTW2g0ID4+IDIwICYgMTVdICsgSEVYX0NIQVJTW2g0ID4+IDE2ICYgMTVdICsgSEVYX0NIQVJTW2g0ID4+IDEyICYgMTVdICsgSEVYX0NIQVJTW2g0ID4+IDggJiAxNV0gKyBIRVhfQ0hBUlNbaDQgPj4gNCAmIDE1XSArIEhFWF9DSEFSU1toNCAmIDE1XTsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmhleCgpOwogICAgfQogICAgZGlnZXN0KCkgewogICAgICAgIHRoaXMuZmluYWxpemUoKTsKICAgICAgICBjb25zdCBoMCA9IHRoaXMuI2gwOwogICAgICAgIGNvbnN0IGgxID0gdGhpcy4jaDE7CiAgICAgICAgY29uc3QgaDIgPSB0aGlzLiNoMjsKICAgICAgICBjb25zdCBoMyA9IHRoaXMuI2gzOwogICAgICAgIGNvbnN0IGg0ID0gdGhpcy4jaDQ7CiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgaDAgPj4gMjQgJiAyNTUsCiAgICAgICAgICAgIGgwID4+IDE2ICYgMjU1LAogICAgICAgICAgICBoMCA+PiA4ICYgMjU1LAogICAgICAgICAgICBoMCAmIDI1NSwKICAgICAgICAgICAgaDEgPj4gMjQgJiAyNTUsCiAgICAgICAgICAgIGgxID4+IDE2ICYgMjU1LAogICAgICAgICAgICBoMSA+PiA4ICYgMjU1LAogICAgICAgICAgICBoMSAmIDI1NSwKICAgICAgICAgICAgaDIgPj4gMjQgJiAyNTUsCiAgICAgICAgICAgIGgyID4+IDE2ICYgMjU1LAogICAgICAgICAgICBoMiA+PiA4ICYgMjU1LAogICAgICAgICAgICBoMiAmIDI1NSwKICAgICAgICAgICAgaDMgPj4gMjQgJiAyNTUsCiAgICAgICAgICAgIGgzID4+IDE2ICYgMjU1LAogICAgICAgICAgICBoMyA+PiA4ICYgMjU1LAogICAgICAgICAgICBoMyAmIDI1NSwKICAgICAgICAgICAgaDQgPj4gMjQgJiAyNTUsCiAgICAgICAgICAgIGg0ID4+IDE2ICYgMjU1LAogICAgICAgICAgICBoNCA+PiA4ICYgMjU1LAogICAgICAgICAgICBoNCAmIDI1NSwgCiAgICAgICAgXTsKICAgIH0KICAgIGFycmF5KCkgewogICAgICAgIHJldHVybiB0aGlzLmRpZ2VzdCgpOwogICAgfQogICAgYXJyYXlCdWZmZXIoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcigyMCk7CiAgICAgICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgICAgICBkYXRhVmlldy5zZXRVaW50MzIoMCwgdGhpcy4jaDApOwogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMig0LCB0aGlzLiNoMSk7CiAgICAgICAgZGF0YVZpZXcuc2V0VWludDMyKDgsIHRoaXMuI2gyKTsKICAgICAgICBkYXRhVmlldy5zZXRVaW50MzIoMTIsIHRoaXMuI2gzKTsKICAgICAgICBkYXRhVmlldy5zZXRVaW50MzIoMTYsIHRoaXMuI2g0KTsKICAgICAgICByZXR1cm4gYnVmZmVyOwogICAgfQp9CmNsYXNzIEhtYWNTaGExIGV4dGVuZHMgU2hhMSB7CiAgICAjc2hhcmVkTWVtb3J5OwogICAgI2lubmVyOwogICAgI29LZXlQYWQ7CiAgICBjb25zdHJ1Y3RvcihzZWNyZXRLZXksIHNoYXJlZE1lbW9yeTIgPSBmYWxzZSl7CiAgICAgICAgc3VwZXIoc2hhcmVkTWVtb3J5Mik7CiAgICAgICAgbGV0IGtleTsKICAgICAgICBpZiAodHlwZW9mIHNlY3JldEtleSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgY29uc3QgYnl0ZXMgPSBbXTsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gc2VjcmV0S2V5Lmxlbmd0aDsKICAgICAgICAgICAgbGV0IGluZGV4ID0gMDsKICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgIGxldCBjb2RlID0gc2VjcmV0S2V5LmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgICAgICBpZiAoY29kZSA8IDEyOCkgewogICAgICAgICAgICAgICAgICAgIGJ5dGVzW2luZGV4KytdID0gY29kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29kZSA8IDIwNDgpIHsKICAgICAgICAgICAgICAgICAgICBieXRlc1tpbmRleCsrXSA9IDE5MiB8IGNvZGUgPj4gNjsKICAgICAgICAgICAgICAgICAgICBieXRlc1tpbmRleCsrXSA9IDEyOCB8IGNvZGUgJiA2MzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29kZSA8IDU1Mjk2IHx8IGNvZGUgPj0gNTczNDQpIHsKICAgICAgICAgICAgICAgICAgICBieXRlc1tpbmRleCsrXSA9IDIyNCB8IGNvZGUgPj4gMTI7CiAgICAgICAgICAgICAgICAgICAgYnl0ZXNbaW5kZXgrK10gPSAxMjggfCBjb2RlID4+IDYgJiA2MzsKICAgICAgICAgICAgICAgICAgICBieXRlc1tpbmRleCsrXSA9IDEyOCB8IGNvZGUgJiA2MzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29kZSA9IDY1NTM2ICsgKChjb2RlICYgMTAyMykgPDwgMTAgfCBzZWNyZXRLZXkuY2hhckNvZGVBdCgrK2kpICYgMTAyMyk7CiAgICAgICAgICAgICAgICAgICAgYnl0ZXNbaW5kZXgrK10gPSAyNDAgfCBjb2RlID4+IDE4OwogICAgICAgICAgICAgICAgICAgIGJ5dGVzW2luZGV4KytdID0gMTI4IHwgY29kZSA+PiAxMiAmIDYzOwogICAgICAgICAgICAgICAgICAgIGJ5dGVzW2luZGV4KytdID0gMTI4IHwgY29kZSA+PiA2ICYgNjM7CiAgICAgICAgICAgICAgICAgICAgYnl0ZXNbaW5kZXgrK10gPSAxMjggfCBjb2RlICYgNjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5ID0gYnl0ZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNlY3JldEtleSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgICAgICAgICAgICBrZXkgPSBuZXcgVWludDhBcnJheShzZWNyZXRLZXkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAga2V5ID0gc2VjcmV0S2V5OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChrZXkubGVuZ3RoID4gNjQpIHsKICAgICAgICAgICAga2V5ID0gbmV3IFNoYTEodHJ1ZSkudXBkYXRlKGtleSkuYXJyYXkoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb0tleVBhZCA9IFtdOwogICAgICAgIGNvbnN0IGlLZXlQYWQgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgNjQ7IGkrKyl7CiAgICAgICAgICAgIGNvbnN0IGIgPSBrZXlbaV0gfHwgMDsKICAgICAgICAgICAgb0tleVBhZFtpXSA9IDkyIF4gYjsKICAgICAgICAgICAgaUtleVBhZFtpXSA9IDU0IF4gYjsKICAgICAgICB9CiAgICAgICAgdGhpcy51cGRhdGUoaUtleVBhZCk7CiAgICAgICAgdGhpcy4jb0tleVBhZCA9IG9LZXlQYWQ7CiAgICAgICAgdGhpcy4jaW5uZXIgPSB0cnVlOwogICAgICAgIHRoaXMuI3NoYXJlZE1lbW9yeSA9IHNoYXJlZE1lbW9yeTI7CiAgICB9CiAgICBmaW5hbGl6ZSgpIHsKICAgICAgICBzdXBlci5maW5hbGl6ZSgpOwogICAgICAgIGlmICh0aGlzLiNpbm5lcikgewogICAgICAgICAgICB0aGlzLiNpbm5lciA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBpbm5lckhhc2ggPSB0aGlzLmFycmF5KCk7CiAgICAgICAgICAgIHN1cGVyLmluaXQodGhpcy4jc2hhcmVkTWVtb3J5KTsKICAgICAgICAgICAgdGhpcy51cGRhdGUodGhpcy4jb0tleVBhZCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlKGlubmVySGFzaCk7CiAgICAgICAgICAgIHN1cGVyLmZpbmFsaXplKCk7CiAgICAgICAgfQogICAgfQp9CnZhciBPcENvZGU7CihmdW5jdGlvbihPcENvZGUxKSB7CiAgICBPcENvZGUxW09wQ29kZTFbIkNvbnRpbnVlIl0gPSAwXSA9ICJDb250aW51ZSI7CiAgICBPcENvZGUxW09wQ29kZTFbIlRleHRGcmFtZSJdID0gMV0gPSAiVGV4dEZyYW1lIjsKICAgIE9wQ29kZTFbT3BDb2RlMVsiQmluYXJ5RnJhbWUiXSA9IDJdID0gIkJpbmFyeUZyYW1lIjsKICAgIE9wQ29kZTFbT3BDb2RlMVsiQ2xvc2UiXSA9IDhdID0gIkNsb3NlIjsKICAgIE9wQ29kZTFbT3BDb2RlMVsiUGluZyJdID0gOV0gPSAiUGluZyI7CiAgICBPcENvZGUxW09wQ29kZTFbIlBvbmciXSA9IDEwXSA9ICJQb25nIjsKfSkoT3BDb2RlIHx8IChPcENvZGUgPSB7Cn0pKTsKZnVuY3Rpb24gdW5tYXNrKHBheWxvYWQsIG1hc2spIHsKICAgIGlmIChtYXNrKSB7CiAgICAgICAgZm9yKGxldCBpMSA9IDAsIGxlbiA9IHBheWxvYWQubGVuZ3RoOyBpMSA8IGxlbjsgaTErKyl7CiAgICAgICAgICAgIHBheWxvYWRbaTFdIF49IG1hc2tbaTEgJiAzXTsKICAgICAgICB9CiAgICB9Cn0KYXN5bmMgZnVuY3Rpb24gd3JpdGVGcmFtZShmcmFtZSwgd3JpdGVyMykgewogICAgY29uc3QgcGF5bG9hZExlbmd0aCA9IGZyYW1lLnBheWxvYWQuYnl0ZUxlbmd0aDsKICAgIGxldCBoZWFkZXI7CiAgICBjb25zdCBoYXNNYXNrID0gZnJhbWUubWFzayA/IDEyOCA6IDA7CiAgICBpZiAoZnJhbWUubWFzayAmJiBmcmFtZS5tYXNrLmJ5dGVMZW5ndGggIT09IDQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgbWFzay4gbWFzayBtdXN0IGJlIDQgYnl0ZXM6IGxlbmd0aD0iICsgZnJhbWUubWFzay5ieXRlTGVuZ3RoKTsKICAgIH0KICAgIGlmIChwYXlsb2FkTGVuZ3RoIDwgMTI2KSB7CiAgICAgICAgaGVhZGVyID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgICAgICAxMjggfCBmcmFtZS5vcGNvZGUsCiAgICAgICAgICAgIGhhc01hc2sgfCBwYXlsb2FkTGVuZ3RoCiAgICAgICAgXSk7CiAgICB9IGVsc2UgaWYgKHBheWxvYWRMZW5ndGggPCA2NTUzNSkgewogICAgICAgIGhlYWRlciA9IG5ldyBVaW50OEFycmF5KFsKICAgICAgICAgICAgMTI4IHwgZnJhbWUub3Bjb2RlLAogICAgICAgICAgICBoYXNNYXNrIHwgMTI2LAogICAgICAgICAgICBwYXlsb2FkTGVuZ3RoID4+PiA4LAogICAgICAgICAgICBwYXlsb2FkTGVuZ3RoICYgMjU1LCAKICAgICAgICBdKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaGVhZGVyID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgICAgICAxMjggfCBmcmFtZS5vcGNvZGUsCiAgICAgICAgICAgIGhhc01hc2sgfCAxMjcsCiAgICAgICAgICAgIC4uLnNsaWNlTG9uZ1RvQnl0ZXMxKHBheWxvYWRMZW5ndGgpLCAKICAgICAgICBdKTsKICAgIH0KICAgIGlmIChmcmFtZS5tYXNrKSB7CiAgICAgICAgaGVhZGVyID0gY29uY2F0MShoZWFkZXIsIGZyYW1lLm1hc2spOwogICAgfQogICAgdW5tYXNrKGZyYW1lLnBheWxvYWQsIGZyYW1lLm1hc2spOwogICAgaGVhZGVyID0gY29uY2F0MShoZWFkZXIsIGZyYW1lLnBheWxvYWQpOwogICAgY29uc3QgdyA9IEJ1ZldyaXRlci5jcmVhdGUod3JpdGVyMyk7CiAgICBhd2FpdCB3LndyaXRlKGhlYWRlcik7CiAgICBhd2FpdCB3LmZsdXNoKCk7Cn0KYXN5bmMgZnVuY3Rpb24gcmVhZEZyYW1lKGJ1ZikgewogICAgbGV0IGIgPSBhd2FpdCBidWYucmVhZEJ5dGUoKTsKICAgIGFzc2VydChiICE9PSBudWxsKTsKICAgIGxldCBpc0xhc3RGcmFtZSA9IGZhbHNlOwogICAgc3dpdGNoKGIgPj4+IDQpewogICAgICAgIGNhc2UgODoKICAgICAgICAgICAgaXNMYXN0RnJhbWUgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIGlzTGFzdEZyYW1lID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCBzaWduYXR1cmUiKTsKICAgIH0KICAgIGNvbnN0IG9wY29kZSA9IGIgJiAxNTsKICAgIGIgPSBhd2FpdCBidWYucmVhZEJ5dGUoKTsKICAgIGFzc2VydChiICE9PSBudWxsKTsKICAgIGNvbnN0IGhhc01hc2sgPSBiID4+PiA3OwogICAgbGV0IHBheWxvYWRMZW5ndGggPSBiICYgMTI3OwogICAgaWYgKHBheWxvYWRMZW5ndGggPT09IDEyNikgewogICAgICAgIGNvbnN0IGwgPSBhd2FpdCByZWFkU2hvcnQoYnVmKTsKICAgICAgICBhc3NlcnQobCAhPT0gbnVsbCk7CiAgICAgICAgcGF5bG9hZExlbmd0aCA9IGw7CiAgICB9IGVsc2UgaWYgKHBheWxvYWRMZW5ndGggPT09IDEyNykgewogICAgICAgIGNvbnN0IGwgPSBhd2FpdCByZWFkTG9uZyhidWYpOwogICAgICAgIGFzc2VydChsICE9PSBudWxsKTsKICAgICAgICBwYXlsb2FkTGVuZ3RoID0gTnVtYmVyKGwpOwogICAgfQogICAgbGV0IG1hc2s7CiAgICBpZiAoaGFzTWFzaykgewogICAgICAgIG1hc2sgPSBuZXcgVWludDhBcnJheSg0KTsKICAgICAgICBhc3NlcnQoYXdhaXQgYnVmLnJlYWRGdWxsKG1hc2spICE9PSBudWxsKTsKICAgIH0KICAgIGNvbnN0IHBheWxvYWQgPSBuZXcgVWludDhBcnJheShwYXlsb2FkTGVuZ3RoKTsKICAgIGFzc2VydChhd2FpdCBidWYucmVhZEZ1bGwocGF5bG9hZCkgIT09IG51bGwpOwogICAgcmV0dXJuIHsKICAgICAgICBpc0xhc3RGcmFtZSwKICAgICAgICBvcGNvZGUsCiAgICAgICAgbWFzaywKICAgICAgICBwYXlsb2FkCiAgICB9Owp9CmNsYXNzIFdlYlNvY2tldEltcGwgewogICAgc2VuZFF1ZXVlID0gW107CiAgICBjb25zdHJ1Y3Rvcih7IGNvbm4gLCBidWZSZWFkZXIgLCBidWZXcml0ZXIgLCBtYXNrICB9KXsKICAgICAgICB0aGlzLmNvbm4gPSBjb25uOwogICAgICAgIHRoaXMubWFzayA9IG1hc2s7CiAgICAgICAgdGhpcy5idWZSZWFkZXIgPSBidWZSZWFkZXIgfHwgbmV3IEJ1ZlJlYWRlcjEoY29ubik7CiAgICAgICAgdGhpcy5idWZXcml0ZXIgPSBidWZXcml0ZXIgfHwgbmV3IEJ1ZldyaXRlcjEoY29ubik7CiAgICB9CiAgICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHsKICAgICAgICBsZXQgZnJhbWVzID0gW107CiAgICAgICAgbGV0IHBheWxvYWRzTGVuZ3RoID0gMDsKICAgICAgICB3aGlsZSghdGhpcy5faXNDbG9zZWQpewogICAgICAgICAgICBsZXQgZnJhbWU7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmcmFtZSA9IGF3YWl0IHJlYWRGcmFtZSh0aGlzLmJ1ZlJlYWRlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5zdXJlU29ja2V0Q2xvc2VkKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB1bm1hc2soZnJhbWUucGF5bG9hZCwgZnJhbWUubWFzayk7CiAgICAgICAgICAgIHN3aXRjaChmcmFtZS5vcGNvZGUpewogICAgICAgICAgICAgICAgY2FzZSBPcENvZGUuVGV4dEZyYW1lOgogICAgICAgICAgICAgICAgY2FzZSBPcENvZGUuQmluYXJ5RnJhbWU6CiAgICAgICAgICAgICAgICBjYXNlIE9wQ29kZS5Db250aW51ZToKICAgICAgICAgICAgICAgICAgICBmcmFtZXMucHVzaChmcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZHNMZW5ndGggKz0gZnJhbWUucGF5bG9hZC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZyYW1lLmlzTGFzdEZyYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbmNhdDMgPSBuZXcgVWludDhBcnJheShwYXlsb2Fkc0xlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvZmZzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBmcmFtZTEgb2YgZnJhbWVzKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdDMuc2V0KGZyYW1lMS5wYXlsb2FkLCBvZmZzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnMgKz0gZnJhbWUxLnBheWxvYWQubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmcmFtZXNbMF0ub3Bjb2RlID09PSBPcENvZGUuVGV4dEZyYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBkZWNvZGUoY29uY2F0Myk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBjb25jYXQzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBwYXlsb2Fkc0xlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBPcENvZGUuQ2xvc2U6CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2RlID0gZnJhbWUucGF5bG9hZFswXSA8PCA4IHwgZnJhbWUucGF5bG9hZFsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhc29uID0gZGVjb2RlKGZyYW1lLnBheWxvYWQuc3ViYXJyYXkoMiwgZnJhbWUucGF5bG9hZC5sZW5ndGgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jbG9zZShjb2RlLCByZWFzb24pOwogICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIE9wQ29kZS5QaW5nOgogICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZW5xdWV1ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wY29kZTogT3BDb2RlLlBvbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IGZyYW1lLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGlzTGFzdEZyYW1lOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgeWllbGQgWwogICAgICAgICAgICAgICAgICAgICAgICAicGluZyIsCiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lLnBheWxvYWQKICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBPcENvZGUuUG9uZzoKICAgICAgICAgICAgICAgICAgICB5aWVsZCBbCiAgICAgICAgICAgICAgICAgICAgICAgICJwb25nIiwKICAgICAgICAgICAgICAgICAgICAgICAgZnJhbWUucGF5bG9hZAogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZGVxdWV1ZSgpIHsKICAgICAgICBjb25zdCBbZW50cnldID0gdGhpcy5zZW5kUXVldWU7CiAgICAgICAgaWYgKCFlbnRyeSkgcmV0dXJuOwogICAgICAgIGlmICh0aGlzLl9pc0Nsb3NlZCkgcmV0dXJuOwogICAgICAgIGNvbnN0IHsgZCAsIGZyYW1lICB9ID0gZW50cnk7CiAgICAgICAgd3JpdGVGcmFtZShmcmFtZSwgdGhpcy5idWZXcml0ZXIpLnRoZW4oKCk9PmQucmVzb2x2ZSgpCiAgICAgICAgKS5jYXRjaCgoZSk9PmQucmVqZWN0KGUpCiAgICAgICAgKS5maW5hbGx5KCgpPT57CiAgICAgICAgICAgIHRoaXMuc2VuZFF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgIHRoaXMuZGVxdWV1ZSgpOwogICAgICAgIH0pOwogICAgfQogICAgZW5xdWV1ZShmcmFtZSkgewogICAgICAgIGlmICh0aGlzLl9pc0Nsb3NlZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRGVuby5lcnJvcnMuQ29ubmVjdGlvblJlc2V0KCJTb2NrZXQgaGFzIGFscmVhZHkgYmVlbiBjbG9zZWQiKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZCA9IGRlZmVycmVkKCk7CiAgICAgICAgdGhpcy5zZW5kUXVldWUucHVzaCh7CiAgICAgICAgICAgIGQsCiAgICAgICAgICAgIGZyYW1lCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuc2VuZFF1ZXVlLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICB0aGlzLmRlcXVldWUoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGQ7CiAgICB9CiAgICBzZW5kKGRhdGEpIHsKICAgICAgICBjb25zdCBvcGNvZGUgPSB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgPyBPcENvZGUuVGV4dEZyYW1lIDogT3BDb2RlLkJpbmFyeUZyYW1lOwogICAgICAgIGNvbnN0IHBheWxvYWQgPSB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgPyBlbmNvZGUoZGF0YSkgOiBkYXRhOwogICAgICAgIGNvbnN0IGlzTGFzdEZyYW1lID0gdHJ1ZTsKICAgICAgICBjb25zdCBmcmFtZSA9IHsKICAgICAgICAgICAgaXNMYXN0RnJhbWU6IHRydWUsCiAgICAgICAgICAgIG9wY29kZSwKICAgICAgICAgICAgcGF5bG9hZCwKICAgICAgICAgICAgbWFzazogdGhpcy5tYXNrCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gdGhpcy5lbnF1ZXVlKGZyYW1lKTsKICAgIH0KICAgIHBpbmcoZGF0YSA9ICIiKSB7CiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHR5cGVvZiBkYXRhID09PSAic3RyaW5nIiA/IGVuY29kZShkYXRhKSA6IGRhdGE7CiAgICAgICAgY29uc3QgZnJhbWUgPSB7CiAgICAgICAgICAgIGlzTGFzdEZyYW1lOiB0cnVlLAogICAgICAgICAgICBvcGNvZGU6IE9wQ29kZS5QaW5nLAogICAgICAgICAgICBtYXNrOiB0aGlzLm1hc2ssCiAgICAgICAgICAgIHBheWxvYWQKICAgICAgICB9OwogICAgICAgIHJldHVybiB0aGlzLmVucXVldWUoZnJhbWUpOwogICAgfQogICAgX2lzQ2xvc2VkID0gZmFsc2U7CiAgICBnZXQgaXNDbG9zZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzQ2xvc2VkOwogICAgfQogICAgYXN5bmMgY2xvc2UoY29kZSA9IDEwMDAsIHJlYXNvbikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGhlYWRlciA9IFsKICAgICAgICAgICAgICAgIGNvZGUgPj4+IDgsCiAgICAgICAgICAgICAgICBjb2RlICYgMjU1CiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGxldCBwYXlsb2FkOwogICAgICAgICAgICBpZiAocmVhc29uKSB7CiAgICAgICAgICAgICAgICBjb25zdCByZWFzb25CeXRlcyA9IGVuY29kZShyZWFzb24pOwogICAgICAgICAgICAgICAgcGF5bG9hZCA9IG5ldyBVaW50OEFycmF5KDIgKyByZWFzb25CeXRlcy5ieXRlTGVuZ3RoKTsKICAgICAgICAgICAgICAgIHBheWxvYWQuc2V0KGhlYWRlcik7CiAgICAgICAgICAgICAgICBwYXlsb2FkLnNldChyZWFzb25CeXRlcywgMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXlsb2FkID0gbmV3IFVpbnQ4QXJyYXkoaGVhZGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCB0aGlzLmVucXVldWUoewogICAgICAgICAgICAgICAgaXNMYXN0RnJhbWU6IHRydWUsCiAgICAgICAgICAgICAgICBvcGNvZGU6IE9wQ29kZS5DbG9zZSwKICAgICAgICAgICAgICAgIG1hc2s6IHRoaXMubWFzaywKICAgICAgICAgICAgICAgIHBheWxvYWQKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgdGhpcy5lbnN1cmVTb2NrZXRDbG9zZWQoKTsKICAgICAgICB9CiAgICB9CiAgICBjbG9zZUZvcmNlKCkgewogICAgICAgIHRoaXMuZW5zdXJlU29ja2V0Q2xvc2VkKCk7CiAgICB9CiAgICBlbnN1cmVTb2NrZXRDbG9zZWQoKSB7CiAgICAgICAgaWYgKHRoaXMuaXNDbG9zZWQpIHJldHVybjsKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmNvbm4uY2xvc2UoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICB0aGlzLl9pc0Nsb3NlZCA9IHRydWU7CiAgICAgICAgICAgIGNvbnN0IHJlc3QgPSB0aGlzLnNlbmRRdWV1ZTsKICAgICAgICAgICAgdGhpcy5zZW5kUXVldWUgPSBbXTsKICAgICAgICAgICAgcmVzdC5mb3JFYWNoKChlKT0+ZS5kLnJlamVjdChuZXcgRGVuby5lcnJvcnMuQ29ubmVjdGlvblJlc2V0KCJTb2NrZXQgaGFzIGFscmVhZHkgYmVlbiBjbG9zZWQiKSkKICAgICAgICAgICAgKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gYWNjZXB0YWJsZShyZXEpIHsKICAgIGNvbnN0IHVwZ3JhZGUgPSByZXEuaGVhZGVycy5nZXQoInVwZ3JhZGUiKTsKICAgIGlmICghdXBncmFkZSB8fCB1cGdyYWRlLnRvTG93ZXJDYXNlKCkgIT09ICJ3ZWJzb2NrZXQiKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3Qgc2VjS2V5ID0gcmVxLmhlYWRlcnMuZ2V0KCJzZWMtd2Vic29ja2V0LWtleSIpOwogICAgcmV0dXJuIHJlcS5oZWFkZXJzLmhhcygic2VjLXdlYnNvY2tldC1rZXkiKSAmJiB0eXBlb2Ygc2VjS2V5ID09PSAic3RyaW5nIiAmJiBzZWNLZXkubGVuZ3RoID4gMDsKfQpjb25zdCBrR1VJRCA9ICIyNThFQUZBNS1FOTE0LTQ3REEtOTVDQS1DNUFCMERDODVCMTEiOwpmdW5jdGlvbiBjcmVhdGVTZWNBY2NlcHQobm9uY2UpIHsKICAgIGNvbnN0IHNoYTEgPSBuZXcgU2hhMSgpOwogICAgc2hhMS51cGRhdGUobm9uY2UgKyBrR1VJRCk7CiAgICBjb25zdCBieXRlcyA9IHNoYTEuZGlnZXN0KCk7CiAgICByZXR1cm4gYnRvYShTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLmJ5dGVzKSk7Cn0KYXN5bmMgZnVuY3Rpb24gYWNjZXB0V2ViU29ja2V0KHJlcSkgewogICAgY29uc3QgeyBjb25uOiBjb25uMSAsIGhlYWRlcnMgLCBidWZSZWFkZXI6IGJ1ZlJlYWRlcjEgLCBidWZXcml0ZXI6IGJ1ZldyaXRlcjEgIH0gPSByZXE7CiAgICBpZiAoYWNjZXB0YWJsZShyZXEpKSB7CiAgICAgICAgY29uc3Qgc29jayA9IG5ldyBXZWJTb2NrZXRJbXBsKHsKICAgICAgICAgICAgY29ubjogY29ubjEsCiAgICAgICAgICAgIGJ1ZlJlYWRlcjogYnVmUmVhZGVyMSwKICAgICAgICAgICAgYnVmV3JpdGVyOiBidWZXcml0ZXIxCiAgICAgICAgfSk7CiAgICAgICAgY29uc3Qgc2VjS2V5ID0gaGVhZGVycy5nZXQoInNlYy13ZWJzb2NrZXQta2V5Iik7CiAgICAgICAgaWYgKHR5cGVvZiBzZWNLZXkgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2VjLXdlYnNvY2tldC1rZXkgaXMgbm90IHByb3ZpZGVkIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNlY0FjY2VwdCA9IGNyZWF0ZVNlY0FjY2VwdChzZWNLZXkpOwogICAgICAgIGNvbnN0IG5ld0hlYWRlcnMgPSBuZXcgSGVhZGVycyh7CiAgICAgICAgICAgIFVwZ3JhZGU6ICJ3ZWJzb2NrZXQiLAogICAgICAgICAgICBDb25uZWN0aW9uOiAiVXBncmFkZSIsCiAgICAgICAgICAgICJTZWMtV2ViU29ja2V0LUFjY2VwdCI6IHNlY0FjY2VwdAogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHNlY1Byb3RvY29sID0gaGVhZGVycy5nZXQoInNlYy13ZWJzb2NrZXQtcHJvdG9jb2wiKTsKICAgICAgICBpZiAodHlwZW9mIHNlY1Byb3RvY29sID09PSAic3RyaW5nIikgewogICAgICAgICAgICBuZXdIZWFkZXJzLnNldCgiU2VjLVdlYlNvY2tldC1Qcm90b2NvbCIsIHNlY1Byb3RvY29sKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2VjVmVyc2lvbiA9IGhlYWRlcnMuZ2V0KCJzZWMtd2Vic29ja2V0LXZlcnNpb24iKTsKICAgICAgICBpZiAodHlwZW9mIHNlY1ZlcnNpb24gPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIG5ld0hlYWRlcnMuc2V0KCJTZWMtV2ViU29ja2V0LVZlcnNpb24iLCBzZWNWZXJzaW9uKTsKICAgICAgICB9CiAgICAgICAgYXdhaXQgd3JpdGVSZXNwb25zZShidWZXcml0ZXIxLCB7CiAgICAgICAgICAgIHN0YXR1czogMTAxLAogICAgICAgICAgICBoZWFkZXJzOiBuZXdIZWFkZXJzCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHNvY2s7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoInJlcXVlc3QgaXMgbm90IGFjY2VwdGFibGUiKTsKfQpjb25zdCBrU2VjQ2hhcnMgPSAiYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXpBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWi0ufl8iOwpmdW5jdGlvbiBjcmVhdGVTZWNLZXkoKSB7CiAgICBsZXQga2V5MSA9ICIiOwogICAgZm9yKGxldCBpMSA9IDA7IGkxIDwgMTY7IGkxKyspewogICAgICAgIGNvbnN0IGogPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBrU2VjQ2hhcnMubGVuZ3RoKTsKICAgICAgICBrZXkxICs9IGtTZWNDaGFyc1tqXTsKICAgIH0KICAgIHJldHVybiBidG9hKGtleTEpOwp9CmNvbnN0IG5vQ29sb3IgPSBnbG9iYWxUaGlzLkRlbm8/Lm5vQ29sb3IgPz8gdHJ1ZTsKbGV0IGVuYWJsZWQgPSAhbm9Db2xvcjsKZnVuY3Rpb24gY29kZShvcGVuLCBjbG9zZSkgewogICAgcmV0dXJuIHsKICAgICAgICBvcGVuOiBgXHgxYlske29wZW4uam9pbigiOyIpfW1gLAogICAgICAgIGNsb3NlOiBgXHgxYlske2Nsb3NlfW1gLAogICAgICAgIHJlZ2V4cDogbmV3IFJlZ0V4cChgXFx4MWJcXFske2Nsb3NlfW1gLCAiZyIpCiAgICB9Owp9CmZ1bmN0aW9uIHJ1bihzdHIxLCBjb2RlMSkgewogICAgcmV0dXJuIGVuYWJsZWQgPyBgJHtjb2RlMS5vcGVufSR7c3RyMS5yZXBsYWNlKGNvZGUxLnJlZ2V4cCwgY29kZTEub3Blbil9JHtjb2RlMS5jbG9zZX1gIDogc3RyMTsKfQpmdW5jdGlvbiBib2xkKHN0cjEpIHsKICAgIHJldHVybiBydW4oc3RyMSwgY29kZShbCiAgICAgICAgMQogICAgXSwgMjIpKTsKfQpjb25zdCBib2xkMSA9IGJvbGQ7CmZ1bmN0aW9uIHJlZChzdHIxKSB7CiAgICByZXR1cm4gcnVuKHN0cjEsIGNvZGUoWwogICAgICAgIDMxCiAgICBdLCAzOSkpOwp9CmNvbnN0IHJlZDEgPSByZWQ7CmZ1bmN0aW9uIGdyZWVuKHN0cjEpIHsKICAgIHJldHVybiBydW4oc3RyMSwgY29kZShbCiAgICAgICAgMzIKICAgIF0sIDM5KSk7Cn0KY29uc3QgZ3JlZW4xID0gZ3JlZW47CmZ1bmN0aW9uIHllbGxvdyhzdHIxKSB7CiAgICByZXR1cm4gcnVuKHN0cjEsIGNvZGUoWwogICAgICAgIDMzCiAgICBdLCAzOSkpOwp9CmNvbnN0IHllbGxvdzEgPSB5ZWxsb3c7CmZ1bmN0aW9uIG1hZ2VudGEoc3RyMSkgewogICAgcmV0dXJuIHJ1bihzdHIxLCBjb2RlKFsKICAgICAgICAzNQogICAgXSwgMzkpKTsKfQpjb25zdCBtYWdlbnRhMSA9IG1hZ2VudGE7CmZ1bmN0aW9uIGJyaWdodEJsYWNrKHN0cjEpIHsKICAgIHJldHVybiBydW4oc3RyMSwgY29kZShbCiAgICAgICAgOTAKICAgIF0sIDM5KSk7Cn0KZnVuY3Rpb24gY2xhbXBBbmRUcnVuY2F0ZShuLCBtYXggPSAyNTUsIG1pbiA9IDApIHsKICAgIHJldHVybiBNYXRoLnRydW5jKE1hdGgubWF4KE1hdGgubWluKG4sIG1heCksIG1pbikpOwp9CmNvbnN0IEFOU0lfUEFUVEVSTiA9IG5ldyBSZWdFeHAoWwogICAgIltcXHUwMDFCXFx1MDA5Ql1bW1xcXSgpIzs/XSooPzooPzooPzpbYS16QS1aXFxkXSooPzo7Wy1hLXpBLVpcXGRcXC8jJi46PT8lQH5fXSopKik/XFx1MDAwNykiLAogICAgIig/Oig/OlxcZHsxLDR9KD86O1xcZHswLDR9KSopP1tcXGRBLVBSLVRaY2YtbnRxcnk9Pjx+XSkpIiwgCl0uam9pbigifCIpLCAiZyIpOwpjbGFzcyBMb2cgewogICAgY2xhc3NOYW1lID0gbnVsbDsKICAgIGNvbnN0cnVjdG9yKHNvdXJjZTEpewogICAgICAgIHRoaXMubG9nT3B0aW9ucyA9IHsKICAgICAgICAgICAgbG9nRHVyaW5nVGVzdGluZzogRGVuby5lbnYuZ2V0KCJMT0dfRFVSSU5HX1RFU1RJTkciKQogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UxID09PSAnc3RyaW5nJykgewogICAgICAgICAgICB0aGlzLmNsYXNzTmFtZSA9IHNvdXJjZTEgPT09ICItIiA/ICItIiA6IHNvdXJjZTEgKyAiLmNsYXNzIjsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmNsYXNzTmFtZSA9IHNvdXJjZTEucHJvdG90eXBlLmNvbnN0cnVjdG9yLm5hbWUgKyAiLmNsYXNzIjsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICB0aGlzLmNsYXNzTmFtZSA9ICJ1bmtub3duIjsKICAgICAgICB9CiAgICB9CiAgICBkZWJ1Zyhtc2csIC4uLnN1cHBvcnRpbmdEZXRhaWxzKSB7CiAgICAgICAgaWYgKERlbm8uZW52LmdldCgiREVCVUciKSkgewogICAgICAgICAgICB0aGlzLmVtaXRMb2dNZXNzYWdlKCJkZWJ1ZyIsIG1zZywgc3VwcG9ydGluZ0RldGFpbHMpOwogICAgICAgIH0KICAgIH0KICAgIGluZm8obXNnLCAuLi5zdXBwb3J0aW5nRGV0YWlscykgewogICAgICAgIHRoaXMuZW1pdExvZ01lc3NhZ2UoImluZm8iLCBtc2csIHN1cHBvcnRpbmdEZXRhaWxzKTsKICAgIH0KICAgIHdhcm4obXNnLCAuLi5zdXBwb3J0aW5nRGV0YWlscykgewogICAgICAgIHRoaXMuZW1pdExvZ01lc3NhZ2UoIndhcm4iLCBtc2csIHN1cHBvcnRpbmdEZXRhaWxzKTsKICAgIH0KICAgIGVycm9yKG1zZywgLi4uc3VwcG9ydGluZ0RldGFpbHMpIHsKICAgICAgICB0aGlzLmVtaXRMb2dNZXNzYWdlKCJlcnJvciIsIG1zZywgc3VwcG9ydGluZ0RldGFpbHMpOwogICAgfQogICAgY29tcGlsZXIobXNnLCBtc2dUeXBlLCAuLi5zdXBwb3J0aW5nRGV0YWlscykgewogICAgICAgIGlmICh0aGlzLmxvZ09wdGlvbnMgJiYgdGhpcy5sb2dPcHRpb25zLmxvZ0R1cmluZ1Rlc3RpbmcgPT09ICJmYWxzZSIpIHJldHVybjsKICAgICAgICBpZiAoc3VwcG9ydGluZ0RldGFpbHMubGVuZ3RoID4gMCkgdGhpc1ttc2dUeXBlXShtc2csIHN1cHBvcnRpbmdEZXRhaWxzKTsKICAgICAgICBlbHNlIHRoaXNbbXNnVHlwZV0obXNnKTsKICAgIH0KICAgIGVtaXRMb2dNZXNzYWdlKG1zZ1R5cGUsIG1zZywgc3VwcG9ydGluZ0RldGFpbHMpIHsKICAgICAgICBsZXQgZmluYWxNZXNzYWdlID0gbnVsbDsKICAgICAgICBzd2l0Y2gobXNnVHlwZSl7CiAgICAgICAgICAgIGNhc2UgImRlYnVnIjoKICAgICAgICAgICAgICAgIGZpbmFsTWVzc2FnZSA9IGAke21hZ2VudGExKGJvbGQxKGBbJHttc2dUeXBlLnRvVXBwZXJDYXNlKCl9IHwgJHtuZXcgRGF0ZSgpLnRvTG9jYWxlU3RyaW5nKCl9XWApKX0gWyR7RGVuby5waWR9XSBbJHt0aGlzLmNsYXNzTmFtZX1dICR7bXNnfWA7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5mbyI6CiAgICAgICAgICAgICAgICBmaW5hbE1lc3NhZ2UgPSBgJHtncmVlbjEoYm9sZDEoYFske21zZ1R5cGUudG9VcHBlckNhc2UoKX0gfCAke25ldyBEYXRlKCkudG9Mb2NhbGVTdHJpbmcoKX1dYCkpfSBbJHtEZW5vLnBpZH1dIFske3RoaXMuY2xhc3NOYW1lfV0gJHttc2d9YDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ3YXJuIjoKICAgICAgICAgICAgICAgIGZpbmFsTWVzc2FnZSA9IGAke3llbGxvdzEoYm9sZDEoYFske21zZ1R5cGUudG9VcHBlckNhc2UoKX0gfCAke25ldyBEYXRlKCkudG9Mb2NhbGVTdHJpbmcoKX1dYCkpfSBbJHtEZW5vLnBpZH1dIFske3RoaXMuY2xhc3NOYW1lfV0gJHttc2d9YDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJlcnJvciI6CiAgICAgICAgICAgICAgICBmaW5hbE1lc3NhZ2UgPSBgJHtyZWQxKGJvbGQxKGBbJHttc2dUeXBlLnRvVXBwZXJDYXNlKCl9IHwgJHtuZXcgRGF0ZSgpLnRvTG9jYWxlU3RyaW5nKCl9XWApKX0gWyR7RGVuby5waWR9XSBbJHt0aGlzLmNsYXNzTmFtZX1dICR7bXNnfWA7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKHN1cHBvcnRpbmdEZXRhaWxzLmxlbmd0aCA+IDApIGNvbnNvbGVbbXNnVHlwZV0oZmluYWxNZXNzYWdlLCBzdXBwb3J0aW5nRGV0YWlscyk7CiAgICAgICAgZWxzZSBjb25zb2xlW21zZ1R5cGVdKGZpbmFsTWVzc2FnZSk7CiAgICB9CiAgICBzdGF0aWMgZ2V0TG9nZ2VyKHNvdXJjZSkgewogICAgICAgIHJldHVybiBuZXcgTG9nKHNvdXJjZSk7CiAgICB9Cn0KY29uc3QgbG9nZ2VyID0gbmV3IExvZygiV2ViV29ya2VyIik7CmxldCBpc0luaXRpYWxpemVkID0gZmFsc2U7CmFzeW5jIGZ1bmN0aW9uIGhhbmRsZVdzKHNvY2spIHsKICAgIHRyeSB7CiAgICAgICAgZm9yIGF3YWl0IChjb25zdCBldiBvZiBzb2NrKXsKICAgICAgICAgICAgaWYgKGV2IGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZShldiwgWwogICAgICAgICAgICAgICAgICAgIGV2CiAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoZXYpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgaWYgKCFzb2NrLmlzQ2xvc2VkKSB7CiAgICAgICAgICAgIGF3YWl0IHNvY2suY2xvc2UoMTAwMCkuY2F0Y2gobG9nZ2VyLmVycm9yKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgZXJyOwogICAgfQp9CmNvbnN0IGluaXRpYWxpemVTb2NrZXQgPSBhc3luYyAocG9ydCwgcmVzdGFydCk9PnsKICAgIGlmICghaXNJbml0aWFsaXplZCB8fCByZXN0YXJ0ID09PSB0cnVlKSB7CiAgICAgICAgaWYgKHJlc3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBsb2dnZXIuaW5mbygiV2ViU29ja2V0IGhhcyBiZWVuIGluaXRpYWxpemVkIGFuZCBpc29sYXRlZCBpbiB3b3JrZXIuIik7CiAgICAgICAgfQogICAgICAgIGZvciBhd2FpdCAoY29uc3QgcmVxIG9mIHNlcnZlKGA6JHtwb3J0fWApKXsKICAgICAgICAgICAgY29uc3QgeyBjb25uOiBjb25uMSAsIHI6IGJ1ZlJlYWRlcjEgLCB3OiBidWZXcml0ZXIxICwgaGVhZGVycyAgfSA9IHJlcTsKICAgICAgICAgICAgYWNjZXB0V2ViU29ja2V0KHsKICAgICAgICAgICAgICAgIGNvbm46IGNvbm4xLAogICAgICAgICAgICAgICAgYnVmUmVhZGVyOiBidWZSZWFkZXIxLAogICAgICAgICAgICAgICAgYnVmV3JpdGVyOiBidWZXcml0ZXIxLAogICAgICAgICAgICAgICAgaGVhZGVycwogICAgICAgICAgICB9KS50aGVuKGhhbmRsZVdzKS5jYXRjaChhc3luYyAoZXJyKT0+ewogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGBGYWlsZWQgdG8gYWNjZXB0IHdlYnNvY2tldDogJHtlcnJ9YCk7CiAgICAgICAgICAgICAgICBhd2FpdCByZXEucmVzcG9uZCh7CiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiA0MDAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaXNJbml0aWFsaXplZCA9IHRydWU7CiAgICB9Cn07CnNlbGYub25tZXNzYWdlID0gYXN5bmMgKHsgZGF0YSAgfSk9PnsKICAgIGNvbnN0IGNtZE9iamVjdCA9IGRhdGE7CiAgICBzd2l0Y2goY21kT2JqZWN0LmNtZCl7CiAgICAgICAgY2FzZSAiSU5JVElBTElaRSI6CiAgICAgICAgICAgIGluaXRpYWxpemVTb2NrZXQoY21kT2JqZWN0LmRhdGEucG9ydC50b1N0cmluZygpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiUkVTVEFSVCI6CiAgICAgICAgICAgIGluaXRpYWxpemVTb2NrZXQoY21kT2JqZWN0LmRhdGEucG9ydC50b1N0cmluZygpLCB0cnVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9Cn07Cg==
`;